<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Updates Feed</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    
    <style>
        /* BASE & LAYOUT (Modified to accommodate right panel) */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            background-color: #e9ebee; 
            padding: 0; 
            margin: 0;
            display: flex; 
            min-height: 100vh;
            overflow-x: hidden; 
        }
        
        /* Sidebar Styling (Left Sidebar - Width fixed) */
        #sidebar {
            width: 250px;
            background-color: #ffffff;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            padding: 20px;
            position: fixed; 
            height: 100%; 
            overflow-y: auto;
            border-right: 1px solid #dcdde1;
            z-index: 10; /* Ensure sidebar is above main content */
        }
        #sidebar h3 {
            color: #2c3e50;
            margin-top: 0;
            border-bottom: 2px solid #bdc3c7;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        #sidebar input[type="text"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }

        /* --- Right Side Panel for PCS Tools --- */
        #rightPanel {
            position: fixed;
            top: 0;
            right: 0;
            width: 280px; /* Wider than the quick jump box */
            height: 100%;
            background-color: #f8f9fa; /* Slightly darker than main body */
            box-shadow: -2px 0 5px rgba(0,0,0,0.1);
            padding: 20px 15px;
            overflow-y: auto;
            z-index: 5;
        }
        #rightPanel h3 {
             color: #2c3e50;
             margin-top: 0;
             border-bottom: 2px solid #bdc3c7;
             padding-bottom: 10px;
             margin-bottom: 15px;
             font-size: 1.1em;
             font-weight: bold;
        }
        .tool-link {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #ffffff;
            border-radius: 6px;
            text-decoration: none;
            color: #34495e;
            font-size: 0.95em;
            transition: background-color 0.2s, color 0.2s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            border-left: 3px solid #2ecc71;
        }
        .tool-link:hover {
            background-color: #e8f5e9; /* Light green hover */
            color: #27ae60;
        }
        .tool-link i {
            margin-right: 12px;
            color: #2ecc71; /* Green for download/external link */
            font-size: 1.2em;
        }
        /* ------------------------------- */
        
        /* Main Content Area (CORRECTED MARGINS) */
        .main-content { 
            margin-left: 250px; /* Clear space for left sidebar */
            margin-right: 280px; /* Clear space for right panel */
            flex-grow: 1; 
            padding: 20px; 
            display: flex; 
            justify-content: center; 
            width: calc(100% - 530px); /* 100% minus 250px left and 280px right */
        }
        .feed-container { max-width: 700px; width: 100%; position: relative; }
        h1 { color: #2c3e50; border-bottom: 2px solid #bdc3c7; padding-bottom: 10px; margin-bottom: 20px; text-align: center; }
        h2 { color: #2c3e50; margin-top: 20px; padding-bottom: 5px; border-bottom: 1px solid #dcdde1; }
        
        /* --- Quick Jump & Status Styles (Rest of styles remain largely the same) --- */

        /* --- NEW: Quick Jump Styling --- */
        #quickJumpBox {
            margin-top: 5px; 
            padding: 10px;
            border: 1px solid #dcdde1;
            border-radius: 6px;
            background-color: #f8f9fa;
        }
        .quick-jump-title {
            display: block;
            font-size: 0.85em;
            padding: 5px 0;
            color: #2c3e50;
            cursor: pointer;
            border-bottom: 1px dotted #ccc;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: color 0.1s;
        }
        .quick-jump-title:last-child {
            border-bottom: none;
        }
        .quick-jump-title:hover {
            color: #3498db;
            text-decoration: underline;
        }

        /* NEW: Show All Link Style */
        #showAllLink {
            display: block;
            font-size: 0.9em;
            font-weight: bold;
            padding: 5px 0 10px 0;
            color: #3498db;
            cursor: pointer;
            text-align: center;
            border-bottom: 1px solid #ccc;
            margin-bottom: 10px;
        }
        #showAllLink:hover {
            color: #2980b9;
        }
        /* ------------------------------- */
        
        /* Auth Status Bar (Same) */
        #userStatus { background-color: #ffffff; border: 1px solid #dcdde1; padding: 10px; margin-bottom: 15px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; font-size: 0.9em; }
        .auth-btn { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: background-color 0.2s; }
        #signInBtn { background-color: #e74c3c; color: white; }
        #signInBtn:hover { background-color: #c0392b; }
        #signOutBtn { background-color: #95a5a6; color: white; }
        #signOutBtn:hover { background-color: #7f8c8d; }

        /* Action Icons (Same) */
        .action-icons { position: absolute; top: 20px; right: 0; display: flex; gap: 15px; }
        .action-icon { cursor: pointer; color: #34495e; font-size: 1.5em; transition: color 0.2s; }
        .action-icon:hover { color: #c0392b; }
        .post-icon:hover { color: #2ecc71; }
        /* NEW: Notification Icon Style */
        #notificationBell { margin-left: -5px; color: #3498db; }
        #notificationBell.active { color: #e74c3c !important; }

        /* NEW: Styles for Cooldown */
        .action-icons #refreshFeedIcon.fa-spin {
            color: #3498db !important;
        }
        .action-icons #refreshFeedIcon.cooldown {
            color: #e74c3c !important; /* Red for cooldown */
            cursor: not-allowed;
        }

        /* Scrollable Feed Area (Same) */
        #feedOutputWrapper { max-height: calc(100vh - 250px); overflow-y: auto; padding-right: 5px; }
        #feedOutputWrapper::-webkit-scrollbar { width: 8px; }
        #feedOutputWrapper::-webkit-scrollbar-thumb { background-color: #bdc3c7; border-radius: 4px; }

        /* Feed Post Styling (Modified for Pin) */
        .feed-post { background: #ffffff; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 15px; margin-bottom: 15px; border-left: 5px solid #3498db; position: relative; }
        .feed-post h3 { color: #2c3e50; margin-top: 0; margin-bottom: 5px; }
        .feed-post .content-display p { white-space: normal; } 
        .feed-post .content-display { font-size: 0.95em; line-height: 1.4; color: #34495e; }
        .feed-post small { color: #7f8c8d; font-size: 0.85em; display: block; margin-top: 10px; }
        
        /* FIX: Management Buttons Positioning */
        .post-actions {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 5px;
            z-index: 5;
        }
        .post-actions button {
            background: #ecf0f1;
            border: 1px solid #dcdde1;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85em;
            cursor: pointer;
            transition: background 0.1s;
            /* Ensure the content is only the text/icon */
            white-space: nowrap; 
        }
        .post-actions button:hover {
            background: #bdc3c7;
        }
        .post-actions button.delete-btn {
            color: #e74c3c;
        }
        /* END FIX */

        /* Like and Comment Styles (Same) */
        /* FIX: Add a hover state for the like count to show the tooltip */
        .like-count {
            cursor: help; 
        }
        .like-btn { background: none; border: none; color: #e74c3c; cursor: pointer; margin-left: 10px; font-size: 0.9em; font-weight: bold; transition: opacity 0.2s; }
        .like-btn:hover { opacity: 0.7; }
        .like-btn.liked { color: #2980b9; } 
        .like-btn.liked:hover { color: #3498db; }
        .like-btn:disabled { cursor: not-allowed; color: #ccc; }
        .like-count { color: #e74c3c; margin-left: 5px; font-weight: bold; }
        .comment-toggle { display: block; margin-top: 10px; font-size: 0.85em; color: #3498db; cursor: pointer; text-align: right; border-top: 1px dashed #ecf0f1; padding-top: 5px; }
        .comment-section { padding-top: 10px; border-top: 1px solid #dcdde1; margin-top: 10px; }
        .comment-item { background-color: #f8f9fa; padding: 8px; margin-bottom: 5px; border-radius: 4px; font-size: 0.9em; position: relative; }
        .comment-meta { font-weight: bold; color: #7f8c8d; font-size: 0.8em; margin-top: 5px; display: flex; justify-content: space-between; align-items: center;}
        .comment-form textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; resize: vertical; min-height: 40px; margin-top: 5px; }
        .comment-form button { background-color: #3498db; color: white; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em; float: right; }
        .delete-comment-btn { background: none; border: none; color: #e74c3c; cursor: pointer; font-size: 0.9em; padding: 0; margin-left: 5px; } /* Reduced margin */
        .comment-actions button { margin-left: 5px; } /* Space out actions */
        
        /* --- TEAMS/SHAREPOINT STYLE CARD --- */
        .media-card-container {
            margin-top: 15px; 
            max-width: 400px; 
            border-radius: 6px; 
            overflow: hidden; 
            box-shadow: 0 3px 10px rgba(0,0,0,0.15); 
        }

        /* Header Section (Dark Background with Overlays) */
        .media-card-header {
            background-color: #222; 
            color: white;
            height: 150px;
            padding: 20px 15px;
            text-align: center;
            position: relative;
            /* Use a linear-gradient overlay for text contrast and a background image placeholder */
            background-image: linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.8)), url('https://via.placeholder.com/400x150/1c1e21/ffffff?text=EAGLEVIEW'); 
            background-size: cover;
            background-position: center;
        }

        .media-card-header .logo {
            position: absolute; 
            top: 15px; 
            left: 15px; 
            font-size: 1.5em; 
            color: #ccc; 
            font-weight: bold;
        }

        .media-card-header .date-text {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8em; 
            color: #aaa; 
            margin: 0;
        }

        .media-card-header h4 { 
            font-size: 1.8em; 
            margin: 30px 0 5px 0; 
            letter-spacing: 2px;
            position: relative; 
        }

        /* Preview Button Style */
        .media-card-preview-btn {
            display: inline-flex;
            align-items: center;
            padding: 10px 20px;
            border: 1px solid white;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 15px; 
            position: absolute; 
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .media-card-preview-btn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        .media-card-preview-btn i { 
            margin-right: 8px; 
        }


        /* Footer Section (File Details - White Background) */
        .media-card-footer { 
            padding: 10px 15px; 
            background-color: #ffffff; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            border: 1px solid #dcdde1;
            border-top: none; 
        }
        .media-card-footer .file-info { 
            display: flex; 
            align-items: center; 
            flex-grow: 1; 
        }
        .media-card-footer .file-info i { 
            color: #e74c3c; /* Red icon for PDF/generic file */
            font-size: 1.5em; 
            margin-right: 8px; 
        }
        .media-card-footer .file-details { 
            display: flex; 
            flex-direction: column; 
            line-height: 1.3; 
        }
        .media-card-filename { 
            font-size: 1em; 
            font-weight: bold; 
            color: #34495e; 
            margin: 0; 
        }
        .file-access { 
            font-size: 0.8em; 
            color: #7f8c8d; 
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .file-actions i { 
            color: #7f8c8d; 
            cursor: pointer; 
            font-size: 1.1em; 
            margin-left: 10px; 
        }
        /* Ensure the old static card is gone */
        .review-card { display: none !important; }

        /* YouTube specific styles for embedded player (Unchanged) */
        .youtube-embed-container {
            margin-top: 15px; 
            max-width: 400px; 
            box-shadow: 0 3px 10px rgba(0,0,0,0.15);
        }
        .youtube-embed-container iframe {
            display: block; 
        }
        
        /* Modal Styling (Updated to include PCS Manager tab) */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); padding-top: 60px; }
        .modal-content { background-color: #ffffff; margin: 5% auto; padding: 30px; border: none; width: 80%; max-width: 700px; border-radius: 10px; box-shadow: 0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23); }
        .close-btn { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; transition: color 0.2s; }
        .close-btn:hover { color: #333; }
        .modal-content h2 { color: #34495e; margin-top: 0; border-bottom: 1px solid #ecf0f1; padding-bottom: 10px; margin-bottom: 20px;}
        .modal-button-group { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .modal-button-group button { padding: 10px 20px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; transition: background-color 0.2s; }
        .btn-primary { background-color: #2ecc71; color: white; }
        .btn-primary:hover { background-color: #27ae60; }
        .btn-secondary { background-color: #ecf0f1; color: #34495e; }
        .btn-secondary:hover { background-color: #bdc3c7; }
        .modal-pin-content { max-width: 400px; text-align: center; }
        .quill-editor-container input[type="text"], 
        #managementArea input[type="text"] { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #dcdde1; border-radius: 6px; box-sizing: border-box; font-size: 1em; }
        .quill-editor-container { margin-bottom: 15px; }
        .quill-editor-container .ql-editor { min-height: 150px; }

        /* Tabs for Management Modal */
        .modal-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #dcdde1;
        }
        .modal-tab-button {
            padding: 10px 15px;
            cursor: pointer;
            border: none;
            background: transparent;
            font-weight: bold;
            color: #7f8c8d;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }
        .modal-tab-button.active {
            color: #3498db;
            border-bottom: 3px solid #3498db;
        }

        /* PCS Tools Manager specific styles */
        #pcsToolsList {
            margin-top: 15px;
        }
        .pcs-tool-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px dotted #ccc;
        }
        .pcs-tool-item:hover {
            background-color: #f8f8f8;
        }
        .pcs-tool-item span {
            font-size: 0.9em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 70%;
        }
        .pcs-tool-actions button {
            background: #ecf0f1;
            border: 1px solid #dcdde1;
            padding: 3px 6px;
            border-radius: 4px;
            font-size: 0.8em;
            cursor: pointer;
            margin-left: 5px;
        }
        .pcs-tool-actions button:hover {
            background: #bdc3c7;
        }
        .pcs-tool-actions button.delete-btn {
            color: #e74c3c;
        }
        
        .modal-content.wide { max-width: 900px; }

    </style>
</head>
<body>
    
    <div id="sidebar">
        <h3><i class="fas fa-history"></i> Announcement History</h3>
        
        <input type="text" id="searchBar" placeholder="Search by Title or Content...">
        
        <div style="margin-top: 25px;">
            <p style="font-size: 0.9em; color: #7f8c8d; margin-bottom: 10px;">Quick Jump:</p>
            <div id="quickJumpBox">
                <a href="#" id="showAllLink" onclick="filterFeed(''); return false;">
                    <i class="fas fa-list"></i> Show All Announcements
                </a>
                <div id="quickJumpList">
                    <span style="display: block; font-size: 0.85em; color: #7f8c8d;">Loading titles...</span>
                </div>
            </div>
        </div>
        
    </div>
    
    <div id="rightPanel">
        <h3><i class="fas fa-toolbox"></i> PCS Tools & Downloads</h3>
        <div id="pcsToolsOutput">
            <p style="font-size: 0.8em; color: #7f8c8d;">Loading tools...</p>
            </div>
        <p style="font-size: 0.75em; color: #7f8c8d; margin-top: 15px;">
            *Links open Google Drive. Access may be restricted.
        </p>
    </div>
    <div class="main-content">
        <div class="feed-container">
            <h1>Project Updates Feed</h1>
            
            <div class="action-icons">
                <i class="fas fa-bell action-icon" id="notificationBell" title="No New Announcements"></i>
                <i class="fas fa-sync-alt action-icon" id="refreshFeedIcon" title="Refresh Feed (5 min cooldown)"></i>
                <i class="fas fa-plus post-icon action-icon" id="postIcon" title="New TL Announcement"></i>
                <i class="fas fa-cog settings-icon action-icon" id="settingsIcon" title="Management Access"></i>
            </div>

            <div id="userStatus">
                <span id="authMessage">Loading user status...</span>
                <button id="signInBtn" class="auth-btn" style="display:none;" onclick="googleSignIn()">
                    <i class="fab fa-google"></i> Sign In
                </button>
                <button id="signOutBtn" class="auth-btn" style="display:none;" onclick="signOutUser()">
                    <i class="fas fa-sign-out-alt"></i> Sign Out
                </button>
            </div>

            <h2>TL Announcements</h2>
            
            <div id="feedOutputWrapper">
                <div id="feedOutput" class="status-message">
                    <i class="fas fa-spinner fa-spin"></i> Initializing Firebase and fetching data...
                </div>
            </div>
        </div>
    </div>
    
    <div id="newPostModal" class="modal">
      <div class="modal-content">
        <span class="close-btn" onclick="closeModal('newPostModal')">&times;</span>
        <h2><i class="fas fa-bullhorn"></i> New TL Announcement</h2>
        <form id="newPostForm" class="modal-form">
            <input type="text" id="postTitle" placeholder="Announcement Title (e.g., Quick Update)" required>
            <input type="text" id="postLink" placeholder="Optional: Link to PDF, YouTube, or Media (e.g., https://youtu.be/videoID or https://example.com/file.pdf)">
            <input type="hidden" id="postUser" required> 
            
            <div class="quill-editor-container">
                <div id="newPostEditor"></div>
            </div>
            
            <div class="modal-button-group">
                <button type="button" class="btn-secondary" onclick="closeModal('newPostModal')">Cancel</button>
                <button type="submit" id="postButton" class="btn-primary">
                    <i class="fas fa-paper-plane"></i> Publish Announcement
                </button>
            </div>
        </form>
        <div id="postStatus" class="status-message" style="display:none; margin-top: 15px;"></div>
      </div>
    </div>

    <div id="managementModal" class="modal">
      <div class="modal-content wide">
        <span class="close-btn" onclick="closeModal('managementModal')">&times;</span>
        <div id="pinEntry">
            <h2><i class="fas fa-unlock-alt"></i> Management Access</h2>
            <p>Enter PIN to access management features (includes post editing AND tool management):</p>
            <input type="password" id="pinInput" placeholder="Enter PIN (2486)" maxlength="4">
            <button onclick="checkPin()">Submit</button>
            <p id="pinError" style="color: red; margin-top: 10px;"></p>
        </div>

        <div id="managementArea" style="display:none;">
            
            <div class="modal-tabs">
                <button class="modal-tab-button active" onclick="switchManagementTab('postEditTab')">
                    <i class="fas fa-edit"></i> Edit Announcement
                </button>
                <button class="modal-tab-button" onclick="switchManagementTab('pcsToolsTab')">
                    <i class="fas fa-tools"></i> Manage PCS Tools
                </button>
            </div>
            
            <div id="postEditTab">
                <h2>Edit Announcement</h2>
                <input type="hidden" id="editPostId">
                <input type="text" id="editTitle" placeholder="Title">
                <input type="text" id="editLink" placeholder="Link to PDF/Media">
                
                <div class="quill-editor-container">
                    <div id="editPostEditor"></div>
                </div>
                
                <div style="text-align: center; margin-bottom: 15px;">
                     <button type="button" id="pinToggleButton" class="btn btn-secondary" onclick="togglePinStatus(document.getElementById('editPostId').value)">
                        <i class="fas fa-thumbtack"></i> Pin/Unpin
                    </button>
                </div>
                
                <div class="modal-button-group">
                    <button type="button" class="btn-secondary" onclick="closeModal('managementModal')">
                        <i class="fas fa-times"></i> Cancel</button>
                    <button onclick="saveEdit()" class="btn-primary">
                        <i class="fas fa-save"></i> Save Changes
                    </button>
                </div>

                <p id="editStatus" style="color: green; margin-top: 10px;"></p>
            </div>

            <div id="pcsToolsTab" style="display: none;">
                <h2>Manage PCS Tool Links</h2>
                
                <form id="newPcsToolForm" onsubmit="event.preventDefault(); savePcsTool();">
                    <input type="hidden" id="toolId">
                    <input type="text" id="toolTitle" placeholder="Tool Name (e.g., Batch Processor Script)" required>
                    <input type="text" id="toolLink" placeholder="Google Drive Share Link (https://drive.google.com/...)" required>
                    <div class="modal-button-group" style="margin-top: 10px; justify-content: flex-start;">
                        <button type="submit" id="pcsToolSubmitBtn" class="btn-primary" style="padding: 8px 15px;">
                            <i class="fas fa-plus"></i> Add New Tool
                        </button>
                    </div>
                </form>

                <h3 style="margin-top: 30px;"><i class="fas fa-list"></i> Current Tool Links</h3>
                <div id="pcsToolsList">
                    <p>Loading tools for management...</p>
                </div>
            </div>
        </div>
      </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    
    <script>
        // --- CONFIGURATION ---
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyA1rWP0ky1L-4TqCwtm0OZZSa76EuymP8o",
            authDomain: "mysocial-3b3fc.firebaseapp.com",
            projectId: "mysocial-3b3fc",
            storageBucket: "mysocial-3b3fc.firebasestorage.app",
            messagingSenderId: "126693884353",
            appId: "1:126693884353:web:2c0af86f20a7e9c8142f40",
        };
        const ADMIN_PIN = "2486"; 
        // Cooldown Constant (5 minutes)
        const REFRESH_COOLDOWN_MS = 5 * 60 * 1000; 

        // --- STATE & INITIALIZATION ---
        let isAdmin = false; 
        let allPosts = []; 
        let allPcsTools = []; // New state array for tools
        const openCommentSections = new Set(); 
        let isCooldownActive = false;
        
        // Initialize Firebase services
        const app = firebase.initializeApp(FIREBASE_CONFIG);
        const db = firebase.firestore();
        const auth = firebase.auth(); 

        // Quill Editor Instances
        let newPostEditor;
        let editPostEditor;

        // --- DOM ELEMENTS ---
        const outputElement = document.getElementById('feedOutput');
        const searchBar = document.getElementById('searchBar');
        const newPostModal = document.getElementById('newPostModal');
        const managementModal = document.getElementById('managementModal');
        const authMessage = document.getElementById('authMessage');
        const signInBtn = document.getElementById('signInBtn');
        const signOutBtn = document.getElementById('signOutBtn');
        const pinInput = document.getElementById('pinInput');
        const pinEntryArea = document.getElementById('pinEntry');
        const managementArea = document.getElementById('managementArea');
        const refreshIcon = document.getElementById('refreshFeedIcon');
        const notificationBell = document.getElementById('notificationBell');
        
        // PCS Tool specific elements
        const pcsToolsOutput = document.getElementById('pcsToolsOutput');
        const pcsToolsList = document.getElementById('pcsToolsList');
        const newPcsToolForm = document.getElementById('newPcsToolForm');
        const toolIdInput = document.getElementById('toolId');
        const toolTitleInput = document.getElementById('toolTitle');
        const toolLinkInput = document.getElementById('toolLink');
        const pcsToolSubmitBtn = document.getElementById('pcsToolSubmitBtn');


        // --- HELPER FUNCTIONS ---
        async function checkLikeStatus(docId, uid) {
            const likerDocRef = db.collection('feedItems').doc(docId).collection('likers').doc(uid);
            const likeButton = document.getElementById(`like-btn-${docId}`);
            if (!likeButton) return;
            try {
                const likerDoc = await likerDocRef.get();
                if (likerDoc.exists) {
                    likeButton.classList.add('liked');
                    likeButton.innerHTML = '<i class="fas fa-thumbs-down"></i> Unlike';
                } else {
                    likeButton.classList.remove('liked');
                    likeButton.innerHTML = '<i class="fas fa-thumbs-up"></i> Like';
                }
            } catch (error) {
                console.error("Error checking like status:", error);
            }
        }
        
        async function showLikers(docId, element) {
            const likersRef = db.collection('feedItems').doc(docId).collection('likers');
            try {
                const snapshot = await likersRef.get();
                let likerNames = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.user) {
                        likerNames.push(escapeHTML(data.user));
                    }
                });
                if (likerNames.length === 0) {
                    element.title = "No likes yet. Be the first!";
                } else {
                    element.title = "Liked by: " + likerNames.join(', ');
                }
            } catch (error) {
                console.error("Error fetching likers:", error);
                element.title = "Failed to load likers.";
            }
        }
        window.showLikers = showLikers; 
        
        const renderHTML = (html) => {
            if (!html) return '';
            const cleanHtml = DOMPurify.sanitize(html, {ALLOWED_TAGS: ['b', 'i', 'u', 's', 'p', 'br', 'a', 'strong', 'em', 'ol', 'ul', 'li', 'h1', 'h2', 'h3', 'span', 'div', 'hr'], ADD_ATTR: ['target', 'href', 'style']});
            return cleanHtml;
        };

        const escapeHTML = (str) => {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str; 
            return div.innerHTML;
        };
        
        const linkify = (text) => {
            if (!text) return '';
            const urlRegex = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
            const tempText = text.replace(/</g, '&lt;').replace(/&gt;/g, '&gt;');
            return tempText.replace(urlRegex, (url) => {
                return `<a href="${url}" target="_blank" style="color: #3498db; text-decoration: underline;">${url}</a>`;
            }).replace(/&lt;/g, '<').replace(/&gt;/g, '>');
        };

        function getFileName(url) {
            try {
                const path = new URL(url).pathname;
                const segments = path.split('/');
                return segments[segments.length - 1];
            } catch (e) {
                return url; 
            }
        }

        function getLinkType(url) {
            if (!url) return null;
            if (url.includes('youtube.com') || url.includes('youtu.be')) return 'youtube';
            if (url.toLowerCase().endsWith('.pdf')) return 'pdf';
            if (url.toLowerCase().match(/\.(jpeg|jpg|gif|png)$/)) return 'image';
            return 'generic';
        }

        function debounce(func, delay = 300) {
            let timeoutId;
            return function(...args) {
                if (timeoutId) {
                    clearTimeout(timeoutId);
                }
                timeoutId = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        }
        
        // --- AUTHENTICATION FUNCTIONS (FIXED SHOW/HIDE LOGIC) ---
        function setupAuthObserver() {
            auth.onAuthStateChanged(user => {
                if (user) {
                    // Update last login
                    db.collection('users').doc(user.uid).set({
                        displayName: user.displayName || user.email,
                        lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
                    }, { merge: true });

                    authMessage.innerHTML = `<i class="fas fa-user-circle"></i> Signed in as: <b>${escapeHTML(user.displayName)}</b>`;
                    signInBtn.style.display = 'none';
                    signOutBtn.style.display = 'block';
                } else {
                    authMessage.innerHTML = '<i class="fas fa-user-times"></i> You must sign in to Like or Comment.';
                    // FIX: Ensure Sign In button is shown when signed out
                    signInBtn.style.display = 'block'; 
                    signOutBtn.style.display = 'none';
                }
                filterFeed(); 
            });
        }
        
        // --- MODAL & PIN MANAGEMENT ---
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        function openNewPostModal() {
            const user = auth.currentUser;
            if (!user) {
                alert("You must be signed in to post an announcement.");
                return;
            }

            document.getElementById('postStatus').style.display = 'none';
            document.getElementById('newPostForm').reset();
            newPostEditor.setContents([]); 
            document.getElementById('newPostModal').style.display = 'block';
            document.getElementById('postUser').value = user.displayName || user.email;
        }

        function openPinModal() {
            pinEntryArea.style.display = 'block';
            managementArea.style.display = 'none';
            pinInput.value = '';
            document.getElementById('pinError').textContent = '';
            document.getElementById('managementModal').style.display = 'block';
            
            switchManagementTab('postEditTab');
            document.getElementById('postEditTab').style.display = 'none';
            document.getElementById('pcsToolsTab').style.display = 'none';
        }

        function checkPin() {
            if (pinInput.value === ADMIN_PIN) {
                isAdmin = true;
                pinEntryArea.style.display = 'none';
                managementArea.style.display = 'block';
                
                switchManagementTab('postEditTab'); 
                loadPcsToolsListForManager();

                filterFeed(); 
            } else {
                document.getElementById('pinError').textContent = 'Incorrect PIN.';
                pinInput.value = '';
            }
        }
        
        function switchManagementTab(tabId) {
            if (!isAdmin) return;

            const tabs = ['postEditTab', 'pcsToolsTab'];
            
            tabs.forEach(id => {
                document.getElementById(id).style.display = 'none';
            });
            document.querySelectorAll('.modal-tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            document.getElementById(tabId).style.display = 'block';
            document.querySelector(`.modal-tab-button[onclick="switchManagementTab('${tabId}')"]`).classList.add('active');

            if (tabId === 'pcsToolsTab') {
                resetPcsToolForm();
                loadPcsToolsListForManager();
            }
        }
        window.switchManagementTab = switchManagementTab;
        
        // --- PCS TOOLS LOGIC ---
        
        async function renderPcsTools() {
            pcsToolsOutput.innerHTML = '<p style="font-size: 0.8em; color: #7f8c8d;"><i class="fas fa-spinner fa-spin"></i> Loading tools...</p>';

            try {
                const snapshot = await db.collection('pcsTools').orderBy('title', 'asc').get();
                allPcsTools = snapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));

                if (allPcsTools.length === 0) {
                    pcsToolsOutput.innerHTML = '<p style="font-size: 0.8em; color: #7f8c8d;">No tools links available yet.</p>';
                    return;
                }

                let html = '';
                allPcsTools.forEach(tool => {
                    const iconClass = tool.data.link.includes('drive.google.com') ? 'fab fa-google-drive' : 'fas fa-external-link-alt';
                    html += `
                        <a href="${escapeHTML(tool.data.link)}" class="tool-link" target="_blank">
                            <i class="${iconClass}"></i> ${escapeHTML(tool.data.title)}
                        </a>
                    `;
                });
                pcsToolsOutput.innerHTML = html;

            } catch (error) {
                console.error("Error fetching PCS tools:", error);
                pcsToolsOutput.innerHTML = '<p style="font-size: 0.8em; color: #c0392b;">Failed to load tools. Check Firebase Security Rules for "pcsTools" collection.</p>';
            }
        }

        function loadPcsToolsListForManager() {
            pcsToolsList.innerHTML = '';
            
            if (allPcsTools.length === 0) {
                 pcsToolsList.innerHTML = '<p style="font-size: 0.8em; color: #7f8c8d;">No tools defined. Add one above.</p>';
                 return;
            }

            let html = '';
            allPcsTools.forEach(tool => {
                const docId = tool.id;
                const toolTitle = escapeHTML(tool.data.title);
                const toolLink = escapeHTML(tool.data.link);
                
                const safeTitle = toolTitle.replace(/'/g, "\\'"); 
                const safeLink = toolLink.replace(/'/g, "\\'"); 

                html += `
                    <div class="pcs-tool-item">
                        <span>${toolTitle}</span>
                        <div class="pcs-tool-actions">
                            <button onclick="openEditPcsTool('${docId}', '${safeTitle}', '${safeLink}')">Edit</button>
                            <button class="delete-btn" onclick="deletePcsTool('${docId}')">Delete</button>
                        </div>
                    </div>
                `;
            });
            pcsToolsList.innerHTML = html;
        }

        async function savePcsTool() {
            if (!isAdmin) return;
            
            const id = toolIdInput.value;
            const title = toolTitleInput.value.trim();
            const link = toolLinkInput.value.trim();
            
            if (!title || !link) return;

            pcsToolSubmitBtn.disabled = true;
            pcsToolSubmitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

            try {
                if (id) {
                    await db.collection('pcsTools').doc(id).update({ title, link });
                } else {
                    await db.collection('pcsTools').add({ title, link });
                }
                
                alert(`Tool ${id ? 'updated' : 'added'} successfully!`);
                resetPcsToolForm();
                await fetchFeedAndTools(); 
                loadPcsToolsListForManager();

            } catch (error) {
                console.error("Error saving PCS tool:", error);
                alert("Failed to save tool. Check Firebase Security Rules for 'pcsTools' collection.");
            } finally {
                pcsToolSubmitBtn.disabled = false;
                pcsToolSubmitBtn.innerHTML = id ? '<i class="fas fa-save"></i> Save Changes' : '<i class="fas fa-plus"></i> Add New Tool';
            }
        }
        window.savePcsTool = savePcsTool;

        function openEditPcsTool(id, title, link) {
            toolIdInput.value = id;
            toolTitleInput.value = title;
            toolLinkInput.value = link;
            pcsToolSubmitBtn.innerHTML = '<i class="fas fa-save"></i> Save Changes';
        }
        window.openEditPcsTool = openEditPcsTool;
        
        function resetPcsToolForm() {
            newPcsToolForm.reset();
            toolIdInput.value = '';
            pcsToolSubmitBtn.innerHTML = '<i class="fas fa-plus"></i> Add New Tool';
        }
        window.resetPcsToolForm = resetPcsToolForm;

        async function deletePcsTool(id) {
            if (!isAdmin) return;
            if (!confirm("Are you sure you want to delete this tool link?")) return;

            try {
                await db.collection('pcsTools').doc(id).delete();
                alert("Tool link deleted successfully!");
                
                await fetchFeedAndTools();
                loadPcsToolsListForManager();

            } catch (error) {
                console.error("Error deleting PCS tool:", error);
                alert("Failed to delete tool. Check Firebase Security Rules for 'pcsTools' collection.");
            }
        }
        window.deletePcsTool = deletePcsTool;

        // --- FETCH ALL DATA (Combined) ---
        async function fetchFeedAndTools() {
            await Promise.all([
                fetchFeed(),
                renderPcsTools()
            ]);
        }
        
        // --- Core Functions (included for completeness) ---

        function googleSignIn() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch(error => {
                console.error("Google Sign-In Error:", error);
                alert(`Sign-in failed: ${error.message}`);
            });
        }
        window.googleSignIn = googleSignIn;

        function signOutUser() {
            auth.signOut().catch(error => {
                console.error("Sign-Out Error:", error);
                alert(`Sign-out failed: ${error.message}`);
            });
        }
        window.signOutUser = signOutUser;
        
        function toggleComments(docId) {
            const commentSection = document.getElementById(`comments-${docId}`);
            if (!commentSection) return;

            if (commentSection.style.display === 'block') {
                commentSection.style.display = 'none';
                openCommentSections.delete(docId);
            } else {
                commentSection.style.display = 'block';
                openCommentSections.add(docId);
                loadComments(docId);
            }
        }
        
        async function loadComments(docId) {
            const commentList = document.getElementById(`comment-list-${docId}`);
            if (!commentList) return;
            
            commentList.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading comments...';

            try {
                const snapshot = await db.collection('feedItems').doc(docId).collection('comments').orderBy('timestamp', 'asc').get();
                
                if (snapshot.empty) {
                    commentList.innerHTML = '<div class="comment-item">No comments yet.</div>';
                    return;
                }

                const user = auth.currentUser;
                let html = '';
                snapshot.forEach(doc => {
                    const comment = doc.data();
                    const commentId = doc.id;
                    const timestamp = comment.timestamp ? (comment.timestamp.toDate ? new Date(comment.timestamp.toDate()).toLocaleString() : new Date(comment.timestamp).toLocaleString()) : 'N/A';
                    
                    const isAuthor = user && user.uid === comment.uid;

                    const deleteButton = isAuthor ? 
                        `<button class="delete-comment-btn" onclick="deleteComment('${docId}', '${commentId}')">
                            <i class="fas fa-trash-alt"></i> Delete
                        </button>` : '';
                    
                    const editButton = isAuthor ? 
                        `<button class="delete-comment-btn" onclick="openCommentEditor('${docId}', '${commentId}')">
                            <i class="fas fa-edit"></i> Edit
                        </button>` : '';

                    const editedLabel = comment.edited ? ' (Edited)' : '';
                    const commentText = linkify(escapeHTML(comment.text)); 
                    
                    html += `
                        <div class="comment-item" id="comment-item-${commentId}">
                            <div id="comment-display-${commentId}">${commentText}</div>
                            
                            <form id="comment-edit-form-${commentId}" style="display:none; margin-top: 5px;" onsubmit="event.preventDefault(); saveCommentEdit('${docId}', '${commentId}')">
                                <textarea id="edit-text-${commentId}" style="width: 100%; padding: 5px; border-radius: 4px; border: 1px solid #ccc; box-sizing: border-box;">${escapeHTML(comment.text)}</textarea>
                                <button type="submit" class="btn-primary" style="float: right; margin-top: 5px; padding: 3px 8px; font-size: 0.8em;">Save</button>
                                <button type="button" class="btn-secondary" style="float: right; margin-top: 5px; margin-right: 5px; padding: 3px 8px; font-size: 0.8em;" onclick="closeCommentEditor('${commentId}')">Cancel</button>
                                <div style="clear: both;"></div>
                            </form>

                            <div class="comment-meta">
                                <span><i class="fas fa-user-circle"></i> ${escapeHTML(comment.user)} - ${timestamp}${editedLabel}</span>
                                <span class="comment-actions">
                                    ${editButton}
                                    ${deleteButton}
                                </span>
                            </div>
                        </div>
                    `;
                });

                commentList.innerHTML = html;

            } catch (error) {
                console.error("Error loading comments:", error);
                commentList.innerHTML = '<div class="comment-item" style="color: #c0392b;">Failed to load comments.</div>';
            }
        }
        
        function openCommentEditor(postId, commentId) {
            const currentTextElement = document.getElementById(`comment-display-${commentId}`);
            const editTextArea = document.getElementById(`edit-text-${commentId}`);
            editTextArea.value = currentTextElement.textContent; 
            currentTextElement.style.display = 'none';
            document.getElementById(`comment-edit-form-${commentId}`).style.display = 'block';
        }

        function closeCommentEditor(commentId) {
            document.getElementById(`comment-display-${commentId}`).style.display = 'block';
            document.getElementById(`comment-edit-form-${commentId}`).style.display = 'none';
        }

        async function saveCommentEdit(postId, commentId) {
            const newText = document.getElementById(`edit-text-${commentId}`).value.trim();
            if (!newText) {
                alert("Comment text cannot be empty.");
                return;
            }
            try {
                await db.collection('feedItems').doc(postId).collection('comments').doc(commentId).update({
                    text: newText,
                    edited: true,
                });
                loadComments(postId); 
            } catch (error) {
                console.error("Error saving comment edit:", error);
                alert("Failed to update comment. Check Firebase Security Rules.");
            }
        }

        async function deleteComment(postId, commentId) {
            if (!confirm("Are you sure you want to delete your comment?")) return;
            const user = auth.currentUser;
            if (!user) {
                 alert("You must be signed in to delete a comment.");
                 return;
            }
            try {
                await db.collection('feedItems').doc(postId).collection('comments').doc(commentId).delete();
                loadComments(postId); 
            } catch (error) {
                console.error("Error deleting comment:", error);
                alert("Failed to delete comment. Check Firebase Security Rules.");
            }
        }
        
        async function likePost(docId) {
            const user = auth.currentUser;
            if (!user) {
                alert("Please sign in with Google to like this announcement.");
                return;
            }
            const likeButton = document.getElementById(`like-btn-${docId}`);
            const likeCountElement = document.getElementById(`like-count-${docId}`);
            likeButton.disabled = true;
            const likerDocRef = db.collection('feedItems').doc(docId).collection('likers').doc(user.uid);
            try {
                const likerDoc = await likerDocRef.get();
                const isLiked = likerDoc.exists;

                if (isLiked) {
                    await db.collection('feedItems').doc(docId).update({ likes: firebase.firestore.FieldValue.increment(-1) });
                    await likerDocRef.delete();
                    likeCountElement.textContent = parseInt(likeCountElement.textContent) - 1;
                    likeButton.classList.remove('liked');
                    likeButton.innerHTML = '<i class="fas fa-thumbs-up"></i> Like';
                } else {
                    await db.collection('feedItems').doc(docId).update({ likes: firebase.firestore.FieldValue.increment(1) });
                    await likerDocRef.set({ user: user.displayName || user.email, timestamp: firebase.firestore.FieldValue.serverTimestamp(), }, { merge: true });
                    likeCountElement.textContent = parseInt(likeCountElement.textContent) + 1;
                    likeButton.classList.add('liked');
                    likeButton.innerHTML = '<i class="fas fa-thumbs-down"></i> Unlike';
                }
            } catch (error) {
                console.error("Error processing like action:", error);
                alert("Failed to complete action. Check Firebase Security Rules.");
            } finally {
                setTimeout(() => { likeButton.disabled = false; }, 500);
            }
        }
        
        function handleRefreshClick() {
            if (isCooldownActive) {
                alert("Feed refresh is on cooldown. Please wait before refreshing again.");
                return;
            }
            startCooldown(); 
            fetchFeedAndTools();
        }

        async function fetchFeed() {
            return new Promise(async (resolve, reject) => {
                try {
                    outputElement.classList.add('status-message');
                    outputElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Fetching announcements...';

                    const pinnedSnapshot = await db.collection('feedItems')
                        .where('isPinned', '==', true)
                        .orderBy('timestamp', 'desc')
                        .get();
                    
                    const unpinnedSnapshot = await db.collection('feedItems')
                        .where('isPinned', '==', false)
                        .orderBy('timestamp', 'desc')
                        .get();
                    
                    const allPostsSnapshot = await db.collection('feedItems')
                        .orderBy('timestamp', 'desc')
                        .get();
                    
                    const pinnedPosts = pinnedSnapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
                    const unpinnedPosts = unpinnedSnapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));

                    const postIds = new Set(pinnedPosts.map(p => p.id));
                    unpinnedPosts.forEach(p => postIds.add(p.id));
                    
                    const otherPosts = allPostsSnapshot.docs
                        .filter(doc => !postIds.has(doc.id)) 
                        .map(doc => ({ id: doc.id, data: doc.data() }));

                    allPosts = pinnedPosts.concat(unpinnedPosts).concat(otherPosts);
                    
                    if (allPosts.length === 0) {
                        outputElement.innerHTML = ' **Connection Successful.** No TL announcements found.';
                        allPosts = [];
                        renderQuickJumpList();
                        checkNewPosts();
                        resolve();
                        return;
                    }

                    renderFeed(allPosts);
                    resolve();

                } catch (error) {
                    console.error("Firebase Fetch Error:", error);
                    outputElement.classList.add('status-message');
                    outputElement.style.color = '#c0392b';
                    outputElement.innerHTML = `
                        <i class="fas fa-skull-crossbones"></i> **ERROR: Failed to fetch data.** <br> 
                        Check Firebase Security Rules.
                    `;
                    checkNewPosts();
                    reject(error);
                }
            });
        }
        
        function renderQuickJumpList() {
            quickJumpList.innerHTML = ''; 

            if (allPosts.length === 0) {
                 quickJumpList.innerHTML = '<span style="display: block; font-size: 0.85em; color: #7f8c8d;">No titles found.</span>';
                 return;
            }

            let jumpHtml = '';
            allPosts.forEach(post => {
                const postTitle = escapeHTML(post.data.title || 'Untitled Announcement');
                const sanitizedTitle = postTitle.replace(/'/g, "\\'"); 
                jumpHtml += `<a href="#" class="quick-jump-title" onclick="document.getElementById('searchBar').value = '${sanitizedTitle}'; filterFeed('${sanitizedTitle}'); return false;">${postTitle}</a>`;
            });
            
            quickJumpList.innerHTML = jumpHtml;
        }

        async function saveEdit() {
            const id = document.getElementById('editPostId').value;
            const newTitle = document.getElementById('editTitle').value.trim();
            const newLink = document.getElementById('editLink').value.trim();
            
            const newContent = editPostEditor.root.innerHTML.trim();
            const hasText = editPostEditor.getText().trim().length > 0;
            
            const editStatusElement = document.getElementById('editStatus');
            
            if (!newTitle || !hasText) {
                 editStatusElement.textContent = 'Title and content cannot be empty.';
                 editStatusElement.style.color = '#e67e22';
                 return;
            }
            
            editStatusElement.textContent = 'Saving...';
            editStatusElement.style.color = '#3498db';

            try {
                await db.collection('feedItems').doc(id).update({
                    title: newTitle,
                    link: newLink, 
                    content: newContent, 
                });

                editStatusElement.textContent = 'Announcement updated successfully!';
                editStatusElement.style.color = '#27ae60';
                setTimeout(() => {
                    closeModal('managementModal');
                    fetchFeedAndTools(); 
                }, 1000);

            } catch (error) {
                console.error("Firebase Edit Error:", error);
                editStatusElement.textContent = 'Update Failed. Check Security Rules (write access)!';
                editStatusElement.style.color = '#c0392b';
            }
        }
        
        async function deletePost(id) {
            if (!isAdmin) {
                alert("Access Denied. Please enter the PIN first.");
                return;
            }
            
            if (confirm("Are you sure you want to permanently delete this announcement?")) {
                try {
                    await db.collection('feedItems').doc(id).delete();
                    alert("Announcement deleted successfully!");
                    fetchFeedAndTools(); 
                } catch (error) {
                    console.error("Firebase Delete Error:", error);
                    alert("Deletion Failed. Check Security Rules (delete access)!");
                }
            }
        }
        
        async function addPost(event) {
            event.preventDefault();

            const user = auth.currentUser;
            const postStatusElement = document.getElementById('postStatus');
            const postButton = document.getElementById('postButton');
            
            if (!user) {
                 postStatusElement.style.display = 'block';
                 postStatusElement.style.color = '#c0392b';
                 postStatusElement.innerHTML = 'Posting failed. You must be signed in to post an announcement.';
                 return;
            }
            
            const posterName = user.displayName || user.email; 

            const title = document.getElementById('postTitle').value.trim();
            const link = document.getElementById('postLink').value.trim();
            
            const content = newPostEditor.root.innerHTML.trim();
            const hasText = newPostEditor.getText().trim().length > 0;

            if (!title || !hasText) {
                postStatusElement.style.display = 'block';
                postStatusElement.style.color = '#e67e22';
                postStatusElement.innerHTML = 'Please fill in the title and content.';
                return;
            }

            postButton.disabled = true;
            postButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Publishing...';
            postStatusElement.style.display = 'none';

            try {
                await db.collection('feedItems').add({
                    title: title,
                    link: link,
                    user: posterName, 
                    content: content, 
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    likes: 0,
                    isPinned: false, 
                    pinnedBy: '',
                });

                postStatusElement.style.display = 'block';
                postStatusElement.style.color = '#27ae60';
                postStatusElement.innerHTML = '<i class="fas fa-check-circle"></i> Announcement published successfully!';
                
                document.getElementById('newPostForm').reset(); 
                newPostEditor.setContents([]); 

                setTimeout(() => {
                    closeModal('newPostModal');
                    fetchFeedAndTools(); 
                }, 800);

            } catch (error) {
                console.error("Firebase Post Error:", error);
                
                postStatusElement.style.display = 'block';
                postStatusElement.style.color = '#c0392b';
                postStatusElement.innerHTML = `
                    <i class="fas fa-exclamation-triangle"></i> **Publishing Failed!** <br> 
                    The most common cause is a **Firebase Security Rule** preventing write access.
                `;
            } finally {
                postButton.disabled = false;
                postButton.innerHTML = '<i class="fas fa-paper-plane"></i> Publish Announcement';
            }
        }


        function checkNewPosts() {
            const user = auth.currentUser;
            if (!user) {
                notificationBell.classList.remove('active');
                notificationBell.title = 'Sign in to track new announcements.';
                return;
            }

            try {
                const userDoc = db.collection('users').doc(user.uid).get();
                userDoc.then(doc => {
                    const lastVisit = doc.exists && doc.data().lastLogin ? doc.data().lastLogin.toDate() : new Date(0);
                    let newPostsCount = 0;
                    
                    allPosts.forEach(post => {
                        const postTime = post.data.timestamp ? (post.data.timestamp.toDate ? post.data.timestamp.toDate() : new Date(post.data.timestamp)) : new Date(0);
                        if (postTime > lastVisit) {
                            newPostsCount++;
                        }
                    });

                    if (newPostsCount > 0) {
                        notificationBell.classList.add('active'); 
                        notificationBell.title = `${newPostsCount} NEW Announcements since your last visit!`;
                    } else {
                        notificationBell.classList.remove('active');
                        notificationBell.title = 'No New Announcements';
                    }
                });

            } catch (error) {
                console.error("Error checking new posts:", error);
                notificationBell.title = 'Error checking status.';
            }
        }

        function renderFeed(postsToRender) {
            outputElement.classList.remove('status-message');
            outputElement.innerHTML = '';
            
            if (searchBar.value.trim() === '') {
                 renderQuickJumpList();
            }

            if (postsToRender.length === 0) {
                 outputElement.classList.add('status-message');
                 outputElement.innerHTML = 'No announcements matched your search/filter criteria.';
                 return;
            }

            const showManagementButtons = isAdmin;
            const user = auth.currentUser; 
            let html = '';

            postsToRender.forEach(post => {
                const item = post.data;
                const docId = post.id;
                const timestamp = item.timestamp ? (item.timestamp.toDate ? new Date(item.timestamp.toDate()).toLocaleString() : new Date(item.timestamp).toLocaleString()) : 'N/A';
                const likes = item.likes || 0;
                const link = item.link || '';
                const postTitle = escapeHTML(item.title || 'Untitled Announcement');
                
                const postContent = renderHTML(item.content || 'No content.');

                const safeTitle = encodeURIComponent(item.title || '');
                const safeLink = encodeURIComponent(link);
                const safeContent = encodeURIComponent(item.content || '');
                
                const managementButtons = showManagementButtons ? `
                    <div class="post-actions">
                        <button onclick="openEditModal('${docId}', '${safeTitle}', '${safeLink}', '${safeContent}')">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="delete-btn" onclick="deletePost('${docId}')">
                            <i class="fas fa-trash-alt"></i> Delete
                        </button>
                    </div>
                ` : '';
                
                const commentsDisplay = openCommentSections.has(docId) ? 'block' : 'none';

                const isPinned = item.isPinned;
                const pinnedBy = item.pinnedBy ? `(Pinned by ${escapeHTML(item.pinnedBy)})` : '';
                const pinnedIndicator = isPinned ? `
                    <div style="font-size: 0.9em; color: #2980b9; font-weight: bold; margin-bottom: 5px;">
                        <i class="fas fa-thumbtack"></i> PINNED ${pinnedBy}
                    </div>
                ` : '';

                const linkType = getLinkType(link);
                let mediaCard = '';

                if (link && linkType === 'youtube') {
                    const videoId = link.match(/(?<=v=|youtu\.be\/)[\w-]+/)?.[0];
                    if (videoId) {
                        mediaCard = `
                            <div class="youtube-embed-container">
                                <iframe width="100%" height="225" src="https://www.youtube.com/embed/${videoId}" 
                                    frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                    allowfullscreen></iframe>
                                <div class="media-card-footer" style="border-left: 5px solid #c0392b;">
                                    <div class="file-info">
                                        <i class="fab fa-youtube" style="color: #c0392b;"></i>
                                        <div class="file-details">
                                            <a href="${link}" target="_blank" style="text-decoration: none;">
                                                <span class="review-card-filename">YouTube Video: ${postTitle}</span>
                                            </a>
                                            <span class="file-access">Watch Now</span>
                                        </div>
                                    </div>
                                    <div class="file-actions">
                                        <i class="fas fa-share-square"></i>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                } else if (link) { 
                    const fileIcon = linkType === 'pdf' ? 'fas fa-file-pdf' : (linkType === 'image' ? 'fas fa-image' : 'fas fa-file');
                    const filePath = `MNL-Accuplus > Accuplus GEO Cen...`; 
                    const fileIconColor = linkType === 'pdf' ? '#e74c3c' : (linkType === 'image' ? '#3498db' : '#95a5a6');

                    mediaCard = `
                        <div class="media-card-container">
                            <a href="${link}" target="_blank" style="text-decoration: none;">
                                <div class="media-card-header">
                                    <span class="logo">EAGLEVIEW</span>
                                    <h4>QUICK UPDATE</h4>
                                    
                                    <div class="media-card-preview-btn">
                                        <i class="fas fa-play"></i> Preview
                                    </div>
                                    <p class="date-text">October 2025</p>
                                </div>
                            </a>
                            
                            <div class="media-card-footer">
                                <div class="file-info">
                                    <i class="${fileIcon}" style="color: ${fileIconColor}"></i>
                                    <div class="file-details">
                                        <a href="${link}" target="_blank" style="text-decoration: none;">
                                            <span class="review-card-filename">${getFileName(link) || 'Linked Document'}</span>
                                        </a>
                                        <span class="file-access">${filePath}</span>
                                    </div>
                                </div>
                                <div class="file-actions">
                                    <i class="fas fa-share-square"></i>
                                </div>
                            </div>
                        </div>
                    `;
                }


                html += `
                    <div class="feed-post" style="border-left: 5px solid ${isPinned ? '#2980b9' : '#3498db'};">
                        ${managementButtons}
                        ${pinnedIndicator}
                        <h3>${postTitle}</h3>
                        <div class="content-display">${postContent}</div>
                        ${mediaCard}
                        <small>
                            <i class="fas fa-user-tag"></i> ${escapeHTML(item.user || 'System')} 
                            &bull; <i class="fas fa-calendar-alt"></i> ${timestamp}
                            
                            <button 
                                id="like-btn-${docId}" 
                                class="like-btn" 
                                onclick="likePost('${docId}')"
                                onmouseover="showLikers('${docId}', this.parentNode.querySelector('#like-count-${docId}'))"
                            >
                                <i class="fas fa-thumbs-up"></i> Like
                            </button>
                            <span 
                                id="like-count-${docId}" 
                                class="like-count" 
                                onmouseover="showLikers('${docId}', this)"
                                title="Hover to see likers"
                            >
                                ${likes}
                            </span>

                        </small>

                        <div class="comment-toggle" onclick="toggleComments('${docId}')">
                            <i class="fas fa-comment"></i> View/Add Comment
                        </div>

                        <div id="comments-${docId}" class="comment-section" style="display: ${commentsDisplay};">
                            <div id="comment-list-${docId}" style="margin-bottom: 15px;">
                                <div class="comment-item">Comments loading...</div>
                            </div>
                            
                            <form id="comment-form-${docId}" class="comment-form" onsubmit="event.preventDefault(); addComment('${docId}');">
                                <textarea id="comment-text-${docId}" placeholder="Sign in to post a comment..."></textarea>
                                <button type="submit">Comment</button>
                                <div style="clear: both;"></div>
                            </form>
                        </div>
                    </div>
                `;
            });

            outputElement.innerHTML = html;
            
            if (user) {
                postsToRender.forEach(post => checkLikeStatus(post.id, user.uid));
            }

            openCommentSections.forEach(docId => loadComments(docId));
            checkNewPosts();
        }

        function startCooldown() {
            isCooldownActive = true;
            
            refreshIcon.classList.add('fa-spin', 'cooldown');
            refreshIcon.title = 'Refreshing...';
            refreshIcon.style.cursor = 'not-allowed';

            setTimeout(() => {
                refreshIcon.classList.remove('fa-spin');
                refreshIcon.title = `On cooldown. Next refresh in ${REFRESH_COOLDOWN_MS / 60000} minutes.`;
            }, 1000); 

            setTimeout(() => {
                isCooldownActive = false;
                refreshIcon.classList.remove('cooldown');
                refreshIcon.title = 'Refresh Feed (5 min cooldown)';
                refreshIcon.style.cursor = 'pointer';
                alert("Feed refresh is now available.");
            }, REFRESH_COOLDOWN_MS);
        }

        
        // --- Expose Global Functions ---
        window.googleSignIn = googleSignIn;
        window.signOutUser = signOutUser;
        window.checkPin = checkPin;
        window.openEditModal = openEditModal; 
        window.saveEdit = saveEdit;
        window.deletePost = deletePost;
        window.closeModal = closeModal;
        window.filterFeed = filterFeed;
        window.likePost = likePost;
        window.toggleComments = toggleComments;
        window.addComment = addComment;
        window.deleteComment = deleteComment;
        window.openCommentEditor = openCommentEditor;
        window.closeCommentEditor = closeCommentEditor;
        window.saveCommentEdit = saveCommentEdit;
        window.handleRefreshClick = handleRefreshClick;
        window.deletePost = deletePost;


        document.addEventListener('DOMContentLoaded', async () => {
            
            try {
                await db.enablePersistence();
                console.log("Firestore persistence enabled.");
            } catch (err) {
                console.error("Could not enable Firestore persistence.", err);
            }
            
            // Initialize Quill Editors after DOM is ready
            const toolbarOptions = [
                ['bold', 'italic', 'underline', 'strike'],
                ['blockquote', 'code-block'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                [{ 'color': [] }, { 'background': [] }],
                ['link', 'clean']
            ];

            newPostEditor = new Quill('#newPostEditor', { theme: 'snow', modules: { toolbar: toolbarOptions } });
            editPostEditor = new Quill('#editPostEditor', { theme: 'snow', modules: { toolbar: toolbarOptions } });

            document.getElementById('searchBar').addEventListener('keyup', debounce(filterFeed));
            
            fetchFeedAndTools();
            setupAuthObserver(); 
            
            document.getElementById('postIcon').addEventListener('click', openNewPostModal);
            document.getElementById('newPostForm').addEventListener('submit', addPost);
            document.getElementById('settingsIcon').addEventListener('click', openPinModal);
            refreshIcon.addEventListener('click', handleRefreshClick);

            window.addEventListener('click', (event) => {
                if (event.target === managementModal) {
                    closeModal('managementModal');
                } else if (event.target === newPostModal) {
                    closeModal('newPostModal');
                }
            });
        });
        
    </script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
</body>
</html>
