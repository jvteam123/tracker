<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevTrack | Team Lead Feed</title>
    
    <style>
        /* --- General Styling (Based on Image Theme) --- */
        body { font-family: Arial, sans-serif; margin: 0; background-color: #f4f7f6; display: flex; }
        
        /* --- Sidebar (Dark Theme) --- */
        #sidebar { 
            width: 250px; 
            background-color: #2b313a; /* Dark Blue/Gray */
            color: #f0f0f0; 
            height: 100vh; 
            padding: 20px 0;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            position: sticky; top: 0;
        }
        .team-header { 
            text-align: center; 
            padding-bottom: 20px; 
            border-bottom: 1px solid #444; 
        }
        .nav-item { 
            padding: 15px 20px; 
            cursor: pointer; 
            display: flex; 
            align-items: center;
            font-size: 1.1em;
        }
        .nav-item:hover, .nav-item.active { 
            background-color: #3e444d; /* Hover/Active State */
        }
        
        /* --- Main Content (Light Theme) --- */
        #content-area { 
            flex-grow: 1; 
            padding: 20px;
        }
        
        /* --- Feed & Posts UI --- */
        .post-container { 
            background-color: white; 
            border-radius: 8px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
            padding: 15px; 
            margin-bottom: 25px;
        }
        .post-header {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 10px;
        }
        .post-title {
            color: #2b313a;
            margin: 0;
        }
        .post-author {
            color: #f44336; /* Red accent for visibility */
            font-weight: bold;
        }
        .post-actions {
            margin-top: 10px;
        }
        
        /* --- Comment Section UI --- */
        .comment-area { 
            border-top: 1px solid #eee; 
            padding-top: 10px; 
            margin-top: 15px; 
        }
        .comment { 
            background-color: #f9f9f9; 
            border-left: 3px solid #f44336; /* Red/accent line */
            padding: 8px; 
            margin-top: 5px; 
            border-radius: 4px;
        }
        
        /* --- Forms and Inputs --- */
        input[type="text"], input[type="url"], textarea, #comment-text-input {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            border: none;
            padding: 8px 15px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        #submit-post-btn { background-color: #4CAF50; color: white; }
        #google-login-btn { background-color: #f44336; color: white; }
        
        /* Media */
        .post-media, .comment-media {
            max-width: 100%;
            max-height: 250px;
            display: block;
            margin: 10px 0;
            border-radius: 4px;
            object-fit: contain;
        }
    </style>
</head>
<body>

    <div id="sidebar">
        <div class="team-header">
            <h2>Team123</h2>
            <small id="signed-in-status">Signed Out</small>
        </div>
        <div id="nav-container">
            <div class="nav-item active">üìã Dashboard (Feed)</div>
            <div class="nav-item">üìà TL Summary</div>
            <div class="nav-item">‚öôÔ∏è Project Settings</div>
            <div class="nav-item">üë• User Management</div>
            <div class="nav-item" id="logout-btn-sidebar" style="display:none;">üîí Log Out</div>
        </div>
    </div>

    <div id="content-area">
        <div id="login-form-container">
            <h2>Sign In to DevTrack</h2>
            <p>Use your Google Account to access the team feed.</p>
            <button id="google-login-btn">Sign In with Google</button>
            <p id="auth-status-message" style="color:#f44336; margin-top: 10px;"></p>
        </div>

        <div id="app-content" style="display:none;">
            <h2>Post New Update</h2>
            <div class="post-container" style="background-color: white;">
                <input type="text" id="post-title-input" placeholder="Update Title (e.g., Q4 Sprint Status)">
                <textarea id="post-text-input" placeholder="Detailed update text or description..."></textarea>
                <input type="url" id="post-link-input" placeholder="Optional: Attach Link URL">
                <input type="file" id="post-image-upload" accept="image/*">
                <button id="submit-post-btn">Publish Update</button>
            </div>
            
            <hr style="border-top: 1px solid #ccc;">

            <h2>Latest Team Updates</h2>
            <div id="feed">
                <p>Loading updates...</p>
            </div>
        </div>
    </div>

    <script type="module">
        // --- 1. FIREBASE MODULAR IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp, doc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyA1rWP0ky1L-4TqCwtm0OZZSa76EuymP8o",
            authDomain: "mysocial-3b3fc.firebaseapp.com",
            projectId: "mysocial-3b3fc",
            storageBucket: "mysocial-3b3fc.firebasestorage.app",
            messagingSenderId: "126693884353",
            appId: "1:126693884353:web:2c0af86f20a7e9c8142f40",
            measurementId: "G-JEYGQQLMQX"
        };

        // 2. INITIALIZE SERVICES
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // --- 3. DOM ELEMENTS ---
        const googleLoginBtn = document.getElementById('google-login-btn');
        const logoutBtnSidebar = document.getElementById('logout-btn-sidebar');
        const authStatusMessage = document.getElementById('auth-status-message');
        const signedInStatus = document.getElementById('signed-in-status');
        const loginFormContainer = document.getElementById('login-form-container');
        const appContent = document.getElementById('app-content');
        const postTitleInput = document.getElementById('post-title-input');
        const postTextInput = document.getElementById('post-text-input');
        const postLinkInput = document.getElementById('post-link-input');
        const postImageUpload = document.getElementById('post-image-upload');
        const submitPostBtn = document.getElementById('submit-post-btn');
        const feedDiv = document.getElementById('feed');

        // --- 4. AUTHENTICATION ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                loginFormContainer.style.display = 'none';
                appContent.style.display = 'block';
                signedInStatus.textContent = `Signed In: ${user.displayName || user.email}`;
                logoutBtnSidebar.style.display = 'block';
                loadFeed();
            } else {
                loginFormContainer.style.display = 'block';
                appContent.style.display = 'none';
                signedInStatus.textContent = 'Signed Out';
                logoutBtnSidebar.style.display = 'none';
                feedDiv.innerHTML = '<p>Please sign in to view the team updates.</p>';
            }
        });

        googleLoginBtn.addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            authStatusMessage.textContent = 'Signing in...';
            try {
                await signInWithPopup(auth, provider);
                authStatusMessage.textContent = 'Login successful!';
            } catch (error) {
                authStatusMessage.textContent = `Sign-in failed: ${error.message}`;
                console.error("Google Auth Error:", error);
            }
        });

        logoutBtnSidebar.addEventListener('click', () => {
            signOut(auth);
            authStatusMessage.textContent = '';
        });


        // --- 5. POST SUBMISSION (Fully Functional) ---
        submitPostBtn.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user || !postTextInput.value.trim()) return alert("Post text required.");

            const imageFile = postImageUpload.files[0];
            let imageURL = null;

            submitPostBtn.disabled = true;
            submitPostBtn.textContent = imageFile ? 'Uploading Image...' : 'Publishing...';

            try {
                // 1. UPLOAD IMAGE to Storage (if present)
                if (imageFile) {
                    const storageRef = ref(storage, `posts/${user.uid}/${Date.now()}_${imageFile.name}`);
                    const snapshot = await uploadBytes(storageRef, imageFile);
                    imageURL = await getDownloadURL(snapshot.ref);
                }

                // 2. WRITE to Firestore
                await addDoc(collection(db, 'posts'), {
                    title: postTitleInput.value.trim(),
                    text: postTextInput.value.trim(),
                    linkURL: postLinkInput.value.trim() || null,
                    imageURL: imageURL,
                    author: user.displayName || user.email,
                    authorId: user.uid,
                    timestamp: serverTimestamp(),
                    commentsCount: 0,
                });

                // Clear fields
                postTitleInput.value = postTextInput.value = postLinkInput.value = postImageUpload.value = '';
            } catch (error) {
                console.error("Error publishing update:", error);
                alert("Failed to publish post: " + error.message);
            } finally {
                submitPostBtn.disabled = false;
                submitPostBtn.textContent = 'Publish Update';
            }
        });

        // --- 6. FEED RENDERING (Functional) ---
        function loadFeed() {
            const postsCol = collection(db, 'posts');
            // Limit to 10 reads for Free Tier efficiency
            const feedQuery = query(postsCol, orderBy('timestamp', 'desc'), limit(10));

            // Real-time listener
            onSnapshot(feedQuery, (snapshot) => {
                feedDiv.innerHTML = '';
                if (snapshot.empty) {
                    feedDiv.innerHTML = '<p>No updates yet. Be the first to post!</p>';
                    return;
                }

                snapshot.forEach(postDoc => {
                    const post = postDoc.data();
                    const postId = postDoc.id;
                    const timestampStr = post.timestamp ? new Date(post.timestamp.toDate()).toLocaleString() : 'Just now';

                    const postElement = document.createElement('div');
                    postElement.className = 'post-container';
                    
                    postElement.innerHTML = `
                        <div class="post-header">
                            <h3 class="post-title">${post.title}</h3>
                            <small class="post-author">${post.author}</small>
                        </div>
                        <p>${post.text}</p>
                        ${post.linkURL ? `<p><a href="${post.linkURL}" target="_blank">üîó Attached Link</a></p>` : ''}
                        ${post.imageURL ? `<img src="${post.imageURL}" class="post-media">` : ''}
                        
                        <small>Posted: ${timestampStr} | Comments: <span id="count-${postId}">${post.commentsCount || 0}</span></small>
                        
                        <div id="comments-section-${postId}" class="comment-area"></div>
                        <div id="comment-form-container-${postId}" class="post-actions" style="margin-top: 10px;">
                            <button onclick="window.toggleCommentForm('${postId}')" style="background-color: #555; color: white;">Add Comment/Reply</button>
                        </div>
                    `;
                    feedDiv.appendChild(postElement);

                    loadComments(postId);
                });
            });
        }

        // --- 7. COMMENTS RENDERING (Functional) ---
        function loadComments(postId) {
            const commentsDiv = document.getElementById(`comments-section-${postId}`);
            // Querying the subcollection
            const commentsQuery = query(collection(db, `posts/${postId}/comments`), orderBy('timestamp', 'asc'));
            
            onSnapshot(commentsQuery, (snapshot) => {
                commentsDiv.innerHTML = '<h5>Comments:</h5>';
                snapshot.forEach(commentDoc => {
                    const comment = commentDoc.data();
                    const commentEl = document.createElement('div');
                    commentEl.className = 'comment';
                    commentEl.innerHTML = `
                        <p style="margin: 0;"><strong>${comment.author}:</strong> ${comment.text}</p>
                        ${comment.imageURL ? `<img src="${comment.imageURL}" class="comment-media">` : ''}
                        `;
                    commentsDiv.appendChild(commentEl);
                });
            });
        }

        // --- 8. GLOBAL COMMENT/REPLY FORM (Fully Functional) ---
        window.toggleCommentForm = (postId) => {
            const container = document.getElementById(`comment-form-container-${postId}`);
            const user = auth.currentUser;
            if (!user) return alert("Please sign in to comment.");

            // If the form already exists, remove it (toggle feature)
            if (container.querySelector('form')) {
                container.innerHTML = `<button onclick="window.toggleCommentForm('${postId}')" style="background-color: #555; color: white;">Add Comment/Reply</button>`;
                return;
            }

            // Create and append the dynamic form
            const form = document.createElement('form');
            form.innerHTML = `
                <textarea id="comment-text-input-${postId}" placeholder="Reply with text..."></textarea>
                <input type="file" id="comment-image-upload-${postId}" accept="image/*">
                <button type="submit" style="background-color: #f44336; color: white;">Submit Reply</button>
                <button type="button" onclick="window.toggleCommentForm('${postId}')" style="background-color: #ccc;">Cancel</button>
                <p id="comment-status-${postId}" style="color: #f44336; margin: 5px 0;"></p>
            `;
            
            form.addEventListener('submit', (e) => submitComment(e, postId));

            // Replace the button with the form
            container.innerHTML = '';
            container.appendChild(form);
        };

        const submitComment = async (e, postId) => {
            e.preventDefault();
            const user = auth.currentUser;
            const statusMsg = document.getElementById(`comment-status-${postId}`);
            
            const commentTextInput = document.getElementById(`comment-text-input-${postId}`);
            const commentImageUpload = document.getElementById(`comment-image-upload-${postId}`);
            
            const commentText = commentTextInput.value.trim();
            const imageFile = commentImageUpload.files[0];
            
            if (!commentText && !imageFile) {
                statusMsg.textContent = "Reply must contain text or an image.";
                return;
            }

            statusMsg.textContent = 'Submitting...';
            let imageURL = null;

            try {
                // 1. UPLOAD IMAGE to Storage (if present)
                if (imageFile) {
                    const storageRef = ref(storage, `comments/${user.uid}/${Date.now()}_${imageFile.name}`);
                    const snapshot = await uploadBytes(storageRef, imageFile);
                    imageURL = await getDownloadURL(snapshot.ref);
                }

                // 2. WRITE to Firestore (Comment Document)
                await addDoc(collection(db, `posts/${postId}/comments`), {
                    text: commentText,
                    imageURL: imageURL,
                    author: user.displayName || user.email,
                    authorId: user.uid,
                    timestamp: serverTimestamp(),
                    // parentCommentId: null, 
                });
                
                // 3. UPDATE Counter on Main Post Document (1 Write for efficiency)
                await updateDoc(doc(db, 'posts', postId), {
                    commentsCount: increment(1)
                });
                
                statusMsg.textContent = 'Reply posted!';
                // Close form after successful submission
                window.toggleCommentForm(postId);

            } catch (error) {
                statusMsg.textContent = `Error posting reply: ${error.message}`;
                console.error("Comment submission error:", error);
            }
        };
    </script>
</body>
</html>
