<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Correction Workflow - Downtime Status</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --card-bg-color: rgba(255, 255, 255, 0.8);
            --text-color: #2c3e50;
            --secondary-text-color: #5a6d7f;
            --accent-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --border-color: rgba(255, 255, 255, 0.6);
            --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
            --border-radius-lg: 16px;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px 20px;
            box-sizing: border-box;
            overflow-y: auto;
        }
        
        .main-card {
            background-color: var(--card-bg-color);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            padding: 40px;
            max-width: 800px;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .animated-icon {
            width: 80px;
            height: 80px;
            margin-bottom: 25px;
        }
        .animated-icon .circle {
            stroke: var(--accent-color);
            stroke-width: 2;
            fill: none;
            animation: pulse 2.5s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(0.8); opacity: 0.5; }
            50% { transform: scale(1); opacity: 1; }
        }
        
        /* Content State */
        .downtime-title {
            font-size: 1.8em;
            font-weight: 700;
            letter-spacing: 0.3em;
            color: var(--secondary-text-color);
            margin: 0 0 15px 0;
        }
        
        #content-container h1 {
            font-size: 1.8em;
            font-weight: 700;
            margin: 0 0 10px 0;
        }
        
        #content-container .subtitle {
            color: var(--secondary-text-color);
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        #project-grid {
            width: 100%;
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
            margin-top: 20px;
        }

        .project-card {
            background-color: #ffffff;
            border-radius: var(--border-radius-lg);
            box-shadow: 0 4px 15px rgba(0,0,0,0.07);
            padding: 25px;
            text-align: left;
            border: 1px solid #e7eaf3;
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }
        .project-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(0,0,0,0.1);
        }

        .project-card h2 {
            margin: 0 0 10px 0;
            font-size: 1.4em;
            font-weight: 600;
        }

        .project-overall-progress {
            margin-bottom: 20px;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 15px;
        }

        .stage-item { margin-bottom: 15px; }
        .stage-item:last-child { margin-bottom: 0; }
        .stage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.95em;
        }
        .stage-header .stage-name { font-weight: 500; }
        .stage-header .stage-progress-text { color: var(--secondary-text-color); }
        .progress-bar {
            width: 100%;
            background-color: #e9ecef;
            border-radius: 25px;
            overflow: hidden;
            height: 10px;
        }
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-color), #85c1e9);
            border-radius: 25px;
            transition: width 0.5s ease-in-out;
        }
        .progress-bar-fill.complete {
             background: linear-gradient(90deg, var(--success-color), #58d68d);
        }

        /* Animated Waiting Bar */
        .progress-bar-fill.waiting {
            background-color: var(--warning-color);
            background-image: linear-gradient(
                -45deg, 
                rgba(255,255,255, .2) 25%, 
                transparent 25%, 
                transparent 50%, 
                rgba(255,255,255, .2) 50%, 
                rgba(255,255,255, .2) 75%, 
                transparent 75%, 
                transparent
            );
            background-size: 40px 40px;
            animation: animate-stripes 2s linear infinite;
        }
        @keyframes animate-stripes {
            0% { background-position: 0 0; }
            100% { background-position: 80px 0; }
        }

        .footer-info {
            font-size: 0.9em;
            color: var(--secondary-text-color);
            border-top: 1px solid #e0e0e0;
            width: 100%;
            padding-top: 20px;
            margin-top: 25px;
        }

        #error-message { color: #e74c3c; font-size: 1.1em; }
    </style>
    <link rel="icon" type="image/png" href="icon.png">
</head>
<body>

    <main class="main-card">
        <div id="loading-container">
            <svg class="animated-icon" viewBox="0 0 40 40">
                <circle class="circle" cx="20" cy="20" r="18" transform-origin="center"></circle>
            </svg>
            <h1>Loading Project Status</h1>
            <p>Please wait while we fetch the latest data.</p>
        </div>

        <div id="content-container" style="display: none;">
            <svg class="animated-icon" viewBox="0 0 40 40">
                <circle class="circle" cx="20" cy="20" r="18" transform-origin="center"></circle>
            </svg>
            <h2 class="downtime-title">D O W N T I M E</h2>
            <h1>Awaiting New Projects</h1>
            <p class="subtitle">There are no projects available for assignment. Please stand by. Below is the live status of all current projects.</p>
            
            <div id="project-grid">
                <!-- Fallback content while loading -->
                <p>Fetching project data...</p>
            </div>

            <div class="footer-info">
                Last checked: <span id="last-checked-time">--:--</span>. This page does not refresh automatically.
            </div>
        </div>
        
        <div id="error-message" style="display: none;"></div>
    </main>
    
    <script src="https://apis.google.com/js/api.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const StatusDashboard = {
                elements: {
                    loadingContainer: document.getElementById('loading-container'),
                    contentContainer: document.getElementById('content-container'),
                    projectGrid: document.getElementById('project-grid'),
                    errorMessage: document.getElementById('error-message'),
                    lastCheckedTime: document.getElementById('last-checked-time'),
                },
                config: {
                    google: {
                        API_KEY: "AIzaSyBxlhWwf3mlS_6Q3BiUsfpH21AsbhVmDw8",
                        SPREADSHEET_ID: "15bhPCYDLChEwO6_uQfvUyq5_qMQp4h816uM26yq3rNY",
                    },
                    sheetName: "Projects",
                     HEADER_MAP: { 'Fix Cat': 'fixCategory', 'Project Name': 'baseProjectName', 'Status': 'status' },
                },

                init() {
                    // Start in a loading state, even if brief
                    this.elements.contentContainer.style.display = 'none';
                    this.elements.loadingContainer.style.display = 'flex';
                    document.body.style.alignItems = 'center';

                    gapi.load('client', this.initializeGapiClient.bind(this));
                },

                async initializeGapiClient() {
                    try {
                        await gapi.client.init({
                            apiKey: this.config.google.API_KEY,
                            discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
                        });
                        await this.loadAndRenderProjects();
                    } catch (error) {
                        this.showError("Could not initialize connection to Google API.");
                        console.error(error);
                    }
                },

                async loadAndRenderProjects() {
                    try {
                        const response = await gapi.client.sheets.spreadsheets.values.get({
                            spreadsheetId: this.config.google.SPREADSHEET_ID,
                            range: this.config.sheetName,
                        });

                        const projects = this.sheetValuesToObjects(response.result.values);
                        const processedData = this.processProjectData(projects);
                        this.render(processedData);

                    } catch (err) {
                        this.showError("Failed to load project data. Please ensure the Google Sheet is public ('Anyone with the link can view').");
                        console.error(err);
                    }
                },

                sheetValuesToObjects(values) {
                    if (!values || values.length < 2) return [];
                    const headers = values[0];
                    const headerMap = this.config.HEADER_MAP;
                    return values.slice(1).map((row) => {
                        let obj = {};
                        headers.forEach((header, i) => {
                            const propName = headerMap[header.trim()];
                            if (propName) obj[propName] = row[i] || "";
                        });
                        return obj;
                    }).filter(p => p.baseProjectName && p.fixCategory);
                },

                processProjectData(projects) {
                    if (!projects || projects.length === 0) return {};
                    
                    const groupedByProject = projects.reduce((acc, task) => {
                        const projectName = task.baseProjectName;
                        if (!acc[projectName]) acc[projectName] = { stages: {}, totalTasks: 0, totalCompleted: 0 };
                        
                        const stage = task.fixCategory || 'Uncategorized';
                        if (!acc[projectName].stages[stage]) {
                            acc[projectName].stages[stage] = { total: 0, completed: 0 };
                        }
                        acc[projectName].stages[stage].total++;
                        acc[projectName].totalTasks++;
                        if (task.status === 'Completed') {
                            acc[projectName].stages[stage].completed++;
                            acc[projectName].totalCompleted++;
                        }
                        return acc;
                    }, {});

                    for (const projectName in groupedByProject) {
                        const project = groupedByProject[projectName];
                        const stageNames = Object.keys(project.stages);

                        const latestStageNum = stageNames.reduce((max, stageName) => {
                            const num = parseInt((stageName || 'Fix0').replace('Fix', ''), 10);
                            return Math.max(max, num);
                        }, 0);
                        
                        project.latestStageNum = latestStageNum;
                        project.nextStage = `Fix${latestStageNum + 1}`;
                    }
                    return groupedByProject;
                },

                render(projectData) {
                    document.body.style.alignItems = 'flex-start';
                    this.elements.loadingContainer.style.display = 'none';
                    this.elements.contentContainer.style.display = 'block';
                    this.elements.projectGrid.innerHTML = '';
                    
                    const projectNames = Object.keys(projectData).sort();

                    if (projectNames.length === 0) {
                        this.elements.projectGrid.innerHTML = '<p>No active project data found.</p>';
                    } else {
                        projectNames.forEach(projectName => {
                            const card = document.createElement('div');
                            card.className = 'project-card';
                            
                            const project = projectData[projectName];
                            const stages = project.stages;
                            const sortedStages = Object.keys(stages).sort((a, b) => a.localeCompare(b, undefined, { numeric: true }));

                            let stagesHTML = '';
                            sortedStages.forEach(stageName => {
                                const stage = stages[stageName];
                                const progress = stage.total > 0 ? (stage.completed / stage.total) * 100 : 0;
                                stagesHTML += `
                                    <div class="stage-item">
                                        <div class="stage-header">
                                            <span class="stage-name">${stageName}</span>
                                            <span class="stage-progress-text">${stage.completed} / ${stage.total}</span>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-bar-fill ${progress === 100 ? 'complete' : ''}" style="width: ${progress.toFixed(2)}%;"></div>
                                        </div>
                                    </div>
                                `;
                            });
                            
                            const overallProgress = project.totalTasks > 0 ? (project.totalCompleted / project.totalTasks) * 100 : 0;
                            
                            // Add the awaiting bar if any stage exists
                            let awaitingStatusHTML = '';
                            if (project.latestStageNum > 0) {
                                awaitingStatusHTML = `
                                    <div class="stage-item">
                                        <div class="stage-header">
                                            <span class="stage-name" style="color: var(--warning-color);">${project.nextStage}</span>
                                            <span class="stage-progress-text">Awaiting Release</span>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress-bar-fill waiting" style="width: 100%;"></div>
                                        </div>
                                    </div>
                                `;
                            }


                            card.innerHTML = `
                                <h2>${projectName.replace(/_/g, ' ')}</h2>
                                <div class="project-overall-progress">
                                    <div class="stage-header">
                                        <span class="stage-name">Overall Progress</span>
                                        <span class="stage-progress-text">${project.totalCompleted} / ${project.totalTasks} Total Tasks</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-bar-fill ${overallProgress === 100 ? 'complete' : ''}" style="width: ${overallProgress.toFixed(2)}%;"></div>
                                    </div>
                                </div>
                                ${stagesHTML}
                                ${awaitingStatusHTML}
                            `;
                            this.elements.projectGrid.appendChild(card);
                        });
                    }
                    this.updateTimestamp();
                },

                updateTimestamp() {
                    const now = new Date();
                    this.elements.lastCheckedTime.textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                },

                showError(message) {
                    const mainCard = document.querySelector('.main-card');
                    mainCard.innerHTML = `<div id="error-message">${message}</div>`;
                },
            };

            StatusDashboard.init();
        });
    </script>
</body>
</html>

