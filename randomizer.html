<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Area Randomizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar for output area */
        #resultTextarea::-webkit-scrollbar {
            width: 8px;
        }
        #resultTextarea::-webkit-scrollbar-thumb {
            background: #d1d5db; /* gray-300 */
            border-radius: 4px;
        }
        #resultTextarea::-webkit-scrollbar-track {
            background: #f3f4f6; /* gray-100 */
        }
        
        /* New CSS for the temporary element used by html2canvas */
        .screenshot-target {
            padding: 20px;
            background-color: #f0fff4; /* bg-green-50 */
            border-radius: 12px;
            white-space: pre-wrap;
            font-family: monospace;
            color: #10b981; /* text-green-800 */
            font-size: 14px;
            max-width: 400px; /* Limit width for a cleaner screenshot image */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            position: absolute;
            left: -9999px; /* Keep it off-screen */
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 md:p-8 font-sans antialiased">

    <div class="max-w-3xl mx-auto bg-white shadow-xl rounded-2xl p-6 md:p-10 border border-gray-100">

        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-extrabold text-indigo-700">Area Randomizer</h1>
            <p class="text-gray-600 mt-2">Your list is automatically saved. Select names and click 'Randomize'.</p>
        </header>

        <section class="mb-6 border-b pb-6">
            <div class="flex justify-between items-center mb-2">
                <label for="bulkInput" class="block text-lg font-semibold text-gray-700">1. Bulk Input (One Name Per Line)</label>
                <div class="flex items-center">
                    <input type="checkbox" id="loadDefaults" onchange="toggleDefaultNames(this.checked)" 
                           class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 cursor-pointer">
                    <label for="loadDefaults" class="ml-2 block text-sm font-medium text-gray-700 cursor-pointer select-none">Use Default List</label>
                </div>
            </div>
            <textarea id="bulkInput" rows="5" placeholder="e.g.,
Alice Johnson
Bob Smith
Charlie Brown
..."
                class="w-full p-4 border-2 border-indigo-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 shadow-inner resize-none text-gray-800"></textarea>

            <div class="flex justify-end mt-4">
                <button onclick="loadNamesFromBulk(true)"
                    class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded-full shadow-md transition duration-200 focus:outline-none focus:ring-2 focus:ring-indigo-300 active:bg-indigo-700">
                    Load/Refresh Selection List
                </button>
            </div>
        </section>

        <section class="mb-8">
            <label class="block text-lg font-semibold text-gray-700 mb-2">2. Names to Include (Check to select)</label>
            <div id="namesSelectionArea" 
                 class="p-4 border border-gray-300 rounded-xl bg-gray-50 max-h-64 overflow-y-auto grid grid-cols-2 md:grid-cols-3 gap-2">
                 <p class="text-gray-500 text-sm col-span-full">Names will load here once entered above or retrieved from storage.</p>
            </div>
        </section>


        <div class="flex justify-center mb-8">
            <button id="randomizeButton" onclick="randomizeNames()"
                class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition duration-300 ease-in-out transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-indigo-300 active:bg-indigo-800 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.836 2.582l-5.582 5.582A2 2 0 0113.414 18H10a2 2 0 00-2 2v2M4 13V9a2 2 0 012-2h4l2-2h4l2 2h4a2 2 0 012 2v4a2 2 0 01-2 2h-4l-2 2v2" />
                </svg>
                Randomize & Number
            </button>
        </div>

        <section>
            <label for="resultTextarea" class="block text-lg font-semibold text-gray-700 mb-2">3. Randomized List</label>
            <div id="resultContainer" class="relative">
                <textarea id="resultTextarea" readonly placeholder="The randomized list will appear here..."
                    class="w-full p-4 h-80 border-2 border-green-300 bg-green-50 rounded-xl shadow-md resize-none text-green-800 font-mono"></textarea>
                
                <button id="copyButton" onclick="copyResult()" disabled
                    class="absolute top-4 right-4 bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-1" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M7 9a2 2 0 012-2h6a2 2 0 012 2v6a2 2 0 01-2 2H9a2 2 0 01-2-2V9z" />
                        <path d="M5 3a2 2 0 00-2 2v6a2 2 0 002 2V5h8a2 2 0 00-2-2H5z" />
                    </svg>
                    Copy
                </button>
                
                <button id="copyScreenshotButton" onclick="copyScreenshot()" disabled
                    class="absolute top-16 right-4 mt-2 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.865-1.155A2 2 0 0111.977 4h2.046a2 2 0 011.664.89l.865 1.155c.334.445.92.89 1.664.89h.93a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    Photo
                </button>

                <div id="messageBox" class="absolute bottom-4 left-0 right-0 p-3 mx-4 rounded-lg text-center font-medium transition-opacity duration-300 opacity-0 pointer-events-none text-sm" style="display: none;"></div>
            </div>
        </section>

    </div>

    <script 
        src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" 
        integrity="sha512-BNaRQODhGkmP/zR0m3+fQ/P0d93/W9g+eN1G5QzD0s1R1M2tV1D1F5+x0B5/2T9A7C7K/v+5+y5+Q==" 
        crossorigin="anonymous" 
        referrerpolicy="no-referrer"
        onerror="document.getElementById('copyScreenshotButton').setAttribute('disabled', 'true'); console.error('html2canvas failed to load from CDN. Check network/security policies.');"
    ></script>

    <script>
        
        // --- LOCAL STORAGE FUNCTIONS AND CONSTANTS ---
        const STORAGE_KEY = 'areaRandomizerList';
        let saveTimeout;

        const DEFAULT_NAMES = `Lorens Christopher Ebrado
Arjohn Abapo
Hyacinth Hortelano
Jayson Aliser
Joana May Taboada
John Vincent Sison
Kenneth Lester Villajos
Nazareno Oppus
Serg Sembrano
Negel Roloma
Vince April Pitogo`;

        function saveNamesToLocalStorage(names) {
            localStorage.setItem(STORAGE_KEY, names);
        }

        function loadNamesFromLocalStorage() {
            const bulkInput = document.getElementById('bulkInput');
            const savedNames = localStorage.getItem(STORAGE_KEY);
            
            if (savedNames) {
                bulkInput.value = savedNames;
                // Auto-load the selection area if names were loaded from persistence
                if (savedNames.trim().length > 0) {
                     // Pass false to suppress the message box on initial load
                     window.loadNamesFromBulk(false); 
                }
            }
        }
        
        // --- END LOCAL STORAGE FUNCTIONS ---
        
        // Function to render the interactive list of names with checkboxes
        function renderNamesList(namesArray) {
            const selectionArea = document.getElementById('namesSelectionArea');
            selectionArea.innerHTML = ''; // Clear previous list
            
            if (namesArray.length === 0) {
                 selectionArea.innerHTML = '<p class="text-gray-500 text-sm col-span-full">List is empty. Enter names in the Bulk Input area.</p>';
                 return;
            }

            namesArray.forEach((name, index) => {
                const div = document.createElement('div');
                div.className = 'flex items-center space-x-2 py-1 px-2 hover:bg-white rounded transition duration-100'; 
                div.innerHTML = `
                    <input type="checkbox" id="name-${index}" name="selectedName" value="${name}" checked 
                           class="h-4 w-4 text-indigo-600 border-gray-400 rounded focus:ring-indigo-500 cursor-pointer flex-shrink-0">
                    <label for="name-${index}" class="text-gray-800 cursor-pointer select-none truncate">${name}</label>
                `;
                selectionArea.appendChild(div);
            });
        }

        // New function to load names from bulk input and render the selectable list
        window.loadNamesFromBulk = function(showMsg = true) {
            const bulkInput = document.getElementById('bulkInput');
            const rawText = bulkInput.value;
            let names = rawText.split('\n')
                               .map(name => name.trim())
                               .filter(name => name.length > 0);
            
            if (names.length === 0) {
                renderNamesList([]);
                if (showMsg) showMessage("Input list is empty!", true);
                return;
            }
            
            renderNamesList(names);
            if (showMsg) showMessage(`Loaded ${names.length} names for selection.`);
            
            // Save to local storage after loading/refreshing
            saveNamesToLocalStorage(rawText);
        }


        // Function to toggle default names based on checkbox state
        window.toggleDefaultNames = function(isChecked) {
            const bulkInput = document.getElementById('bulkInput');
            if (isChecked) {
                bulkInput.value = DEFAULT_NAMES;
                // Auto-load the list when defaults are checked for better flow
                window.loadNamesFromBulk(true); 
            } else {
                // Only clear the textarea if its content exactly matches the default list (to preserve user input)
                if (bulkInput.value.trim() === DEFAULT_NAMES.trim()) {
                    bulkInput.value = "";
                }
                // If the input is now empty, clear the selection area
                if (bulkInput.value.trim().length === 0) {
                     renderNamesList([]);
                }
            }
            // Trigger a save after changing the input
            saveNamesToLocalStorage(bulkInput.value);
        }

        // Use a simple custom message box for feedback instead of alert()
        function showMessage(text, isError = false) {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = text;
            messageBox.style.display = 'block';
            messageBox.classList.remove('opacity-0', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');

            if (isError) {
                messageBox.classList.add('bg-red-100', 'text-red-700');
            } else {
                messageBox.classList.add('bg-green-100', 'text-green-700');
            }

            // Animate fade in and out
            setTimeout(() => {
                messageBox.classList.add('opacity-100');
            }, 10);
            
            setTimeout(() => {
                messageBox.classList.remove('opacity-100');
                messageBox.classList.add('opacity-0');
            }, 2000);

            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 2300);
        }

        // Fisher-Yates (Knuth) Shuffle Algorithm
        function shuffleArray(array) {
            let currentIndex = array.length, randomIndex;

            // While there remain elements to shuffle.
            while (currentIndex != 0) {
                // Pick a remaining element.
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;

                // And swap it with the current element.
                [array[currentIndex], array[randomIndex]] = [
                    array[randomIndex], array[currentIndex]];
            }

            return array;
        }

        // Updated randomizeNames function to read selected names from the checkboxes
        window.randomizeNames = function() {
            const resultTextarea = document.getElementById('resultTextarea');
            const copyButton = document.getElementById('copyButton');
            const copyScreenshotButton = document.getElementById('copyScreenshotButton'); 
            // Get all CHECKED checkboxes in the selection area
            const checkboxes = document.querySelectorAll('#namesSelectionArea input[type="checkbox"]:checked');
            
            // Extract the value (name) from each checked checkbox
            let names = Array.from(checkboxes).map(cb => cb.value);

            if (names.length === 0) {
                resultTextarea.value = "No names were selected for randomization. Please load a list and check one or more boxes.";
                copyButton.disabled = true;
                copyScreenshotButton.disabled = true; 
                showMessage("No names selected!", true);
                return;
            }

            // Shuffle the array
            const shuffledNames = shuffleArray(names);

            // Format with new numbering (1., 2., 3., etc.)
            const numberedList = shuffledNames.map((name, index) => {
                return `${index + 1}. ${name}`;
            }).join('\n');

            // Display result
            resultTextarea.value = numberedList;
            copyButton.disabled = false;
            // Only enable the photo button if the library is loaded (window.html2canvas exists)
            copyScreenshotButton.disabled = (typeof window.html2canvas === 'undefined'); 
            showMessage(`Successfully randomized and numbered ${names.length} selected names!`);
        }

        window.copyResult = function() {
            const resultTextarea = document.getElementById('resultTextarea');
            
            // Check if there is content to copy
            if (resultTextarea.value.length === 0 || resultTextarea.value.includes("will appear here")) {
                showMessage("Nothing to copy yet!", true);
                return;
            }

            // Select the text
            resultTextarea.select();
            
            try {
                // Execute copy command
                document.execCommand('copy');
                showMessage("Randomized list copied to clipboard!");
            } catch (err) {
                console.error('Could not copy text: ', err);
                showMessage("Copy failed. Please select and copy manually.", true);
            }
        }
        
        // --- FUNCTION: Copy Screenshot (Fixed for global html2canvas) ---
        window.copyScreenshot = async function() {
            const html2canvas_global = window.html2canvas;

            if (typeof html2canvas_global === 'undefined') {
                 // Check if the script failed to load (by checking the console error from the onerror attribute on the CDN script tag)
                 showMessage("Screenshot library failed to load. Check your browser console for network errors or try refreshing.", true);
                 return;
            }

            const resultTextarea = document.getElementById('resultTextarea');
            const copyScreenshotButton = document.getElementById('copyScreenshotButton');
            const copyButton = document.getElementById('copyButton');

            if (resultTextarea.value.length === 0 || resultTextarea.value.includes("will appear here")) {
                showMessage("Nothing to capture yet!", true);
                return;
            }

            // 1. Temporarily hide buttons and disable button during capture
            copyScreenshotButton.disabled = true;
            copyButton.style.opacity = '0';
            copyScreenshotButton.style.opacity = '0';
            
            showMessage("Capturing image...", false);

            // 2. Create a temporary styled container to hold the text content for a clean screenshot
            const tempDiv = document.createElement('div');
            tempDiv.className = 'screenshot-target';
            tempDiv.textContent = resultTextarea.value;
            
            document.body.appendChild(tempDiv);
            
            try {
                // 3. Render the off-screen div to a canvas
                const canvas = await html2canvas_global(tempDiv, {
                    scale: 2, // Capture at a higher resolution
                    backgroundColor: null, // Allow CSS background to show
                    logging: false
                });
                
                // 4. Convert canvas to Blob and copy to clipboard
                canvas.toBlob(async (blob) => {
                    if (!blob) {
                        showMessage("Failed to generate image.", true);
                        return;
                    }
                    
                    try {
                        // Check if ClipboardItem is supported (required for image copy)
                        if (typeof ClipboardItem === 'undefined') {
                             throw new Error("ClipboardItem API not supported by this browser.");
                        }

                        const item = new ClipboardItem({'image/png': blob});
                        await navigator.clipboard.write([item]);
                        showMessage("Screenshot copied to clipboard!");
                    } catch (err) {
                        showMessage("Clipboard write failed. Ensure your browser allows image copy.", true);
                        console.error('Clipboard write error:', err);
                    }
                }, 'image/png');

            } catch(e) {
                showMessage(`Screenshot failed: ${e.message}`, true);
                console.error('html2canvas error:', e);
            } finally {
                // 5. Cleanup and restore
                document.body.removeChild(tempDiv);
                copyScreenshotButton.disabled = false;
                copyButton.style.opacity = '1';
                copyScreenshotButton.style.opacity = '1';
            }
        }

        // --- APPLICATION STARTUP ---
        window.onload = function() {
            // Load saved state from local storage
            loadNamesFromLocalStorage();

            const bulkInput = document.getElementById('bulkInput');
            // Save state on every input change, debounced to 1000ms
            bulkInput.addEventListener('input', () => {
                // Use a debounce function to avoid saving on every key stroke
                clearTimeout(window.saveTimeout);
                window.saveTimeout = setTimeout(() => saveNamesToLocalStorage(bulkInput.value), 1000);
            });
        };
    </script>
</body>
</html>
