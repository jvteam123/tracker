<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PCS Advanced Bonus Calculator</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://unpkg.com/shapefile@0.6.6/dist/shapefile.js"></script>
    
    <link rel="stylesheet" href="style.css">
</head>
<body class="bg-gray-900 text-gray-300">

    <div id="update-notification" class="hidden fixed top-5 right-5 bg-green-600 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transform translate-y-2">
        Project list updated.
    </div>

    <div class="w-full max-w-screen-xl mx-auto p-4 md:p-8">
        <div class="bg-gray-800 rounded-2xl shadow-2xl overflow-hidden border border-gray-700">
            <div class="p-6 md:p-8 bg-gray-900/50 text-white flex justify-between items-center">
                <div>
                    <h1 class="text-2xl md:text-3xl font-bold text-white">PCS Advanced Bonus Calculator</h1>
                    <p class="mt-2 text-gray-400">Save, load, and calculate bonuses for multiple projects locally.</p>
                </div>
                 <div class="flex gap-4">
                    <button id="how-it-works-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-300 shadow-md">How It Works</button>
                    <button id="merge-fixpoints-btn" class="bg-teal-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-700">Merge Fixpoints</button>
                    <button id="manage-teams-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700">Manage Teams</button>
                </div>
            </div>
            
            <div class="px-6 md:px-8 pt-6">
                 <div class="card p-4 rounded-xl mb-6 bg-gray-900/30 border-gray-700/80">
                    <h3 class="text-base font-semibold text-gray-200 mb-2">Important Information</h3>
                    <p class="text-xs text-gray-400 mb-2"><strong class="text-gray-300">Calculation Logic:</strong> This calculator is based on the formulas and tables provided in the "Phili IC Fixpoints App Documentation v1.0." The logic employed in all calculations is designed to be transparent and accurate according to this official documentation.</p>
                    <p class="text-xs text-gray-400"><strong class="text-gray-300">Disclaimer and Intended Use:</strong> This tool is intended for personal and informational purposes only. The results generated are estimates and should be used as a general guideline. These figures are not a guarantee of actual compensation and may differ from official salary offers or personal expectations.</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 border-t border-gray-700 pt-6">
                    <div>
                        <h2 class="text-xl font-semibold text-gray-100 border-b border-gray-700 pb-3 mb-4">Local Database Status</h2>
                        <p id="db-status" class="text-sm text-gray-400 mb-4">Initializing database...</p>
                    </div>
                    <div>
                        <h2 class="text-xl font-semibold text-gray-100 border-b border-gray-700 pb-3 mb-4">New Updates</h2>
                        <div id="updates-list" class="text-sm text-gray-400 space-y-2">
                            </div>
                    </div>
                </div>
            </div>

            <div id="main-grid" class="p-6 md:p-8 grid grid-cols-1 lg:grid-cols-5 gap-8">

                <div class="lg:col-span-2 space-y-6">
                     <div class="card p-6 rounded-xl">
                        <div class="flex justify-between items-center border-b border-gray-700 pb-3 mb-4">
                            <h2 class="text-xl font-semibold text-gray-100">Project Management</h2>
                            <div class="flex gap-2">
                                <button id="reorder-projects-btn" class="bg-gray-600 text-gray-200 font-bold py-1 px-3 rounded-lg hover:bg-gray-500 transition-colors text-sm">Reorder</button>
                                <button id="refresh-projects-btn" title="Refresh Project List" class="p-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/><path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/></svg>
                                </button>
                            </div>
                        </div>

                         <div class="flex items-center gap-2">
                            <select id="project-select" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition-all duration-300">
                                <option value="">Select a project to load...</option>
                            </select>
                             <button id="delete-project-btn" title="Delete Selected Project" class="p-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:bg-red-800 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>
                             </button>
                        </div>
                        <div class="mt-4">
                            <button id="calculateCurrentBtn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition-colors duration-300 shadow-md">
                                Calculate Selected Project
                            </button>
                        </div>
                         <div class="mt-4 border-t border-gray-700 pt-4">
                             <div class="flex items-center">
                                <input id="customize-calc-all-cb" type="checkbox" class="h-4 w-4 text-indigo-500 focus:ring-indigo-600 bg-gray-700 border-gray-600 rounded">
                                <label for="customize-calc-all-cb" class="ml-3 block text-sm font-medium text-gray-300">Select specific projects to calculate</label>
                            </div>
                            <button id="calculate-all-btn" class="mt-2 w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-700 transition-colors duration-300 shadow-md">Calculate All Projects</button>
                        </div>
                    </div>
                    <div class="card p-6 rounded-xl">
                        <h2 class="text-xl font-semibold text-gray-100 border-b border-gray-700 pb-3 mb-4">Calculation Settings</h2>
                        <div>
                            <label for="bonusMultiplierDirect" class="block text-sm font-medium text-gray-400 mb-1">
                                Bonus Multiplier (PHP)
                                <span class="info-icon" data-key="bonusMultiplier">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.064.293.006.399.287.47l.45.083.082.38-2.29.287-.082-.38.45-.083a.89.89 0 0 1 .352-.176c.24-.11.24-.216.06-.563l-.738-3.468c-.18-.84.48-1.133 1.17-1.133H8l.084.38zM8 5.5a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/></svg>
                                </span>
                            </label>
                            <input type="number" id="bonusMultiplierDirect" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Default: 1 (No multiplier)">
                        </div>
                    </div>

                    <div id="performance-metrics-card" class="card p-6 rounded-xl">
                        <h2 class="text-xl font-semibold text-gray-100 border-b border-gray-700 pb-3 mb-4">Team & Technician Performance Metrics</h2>
                        <div class="space-y-4">
                            <div>
                                <div class="flex justify-between items-center mb-2">
                                    <div>
                                        <h3 class="font-semibold text-gray-200">Task Leaderboard</h3>
                                        <p class="text-xs text-gray-400">Ranking based on calculated tasks for the selected project(s).</p>
                                    </div>
                                    <select id="leaderboard-sort-select" class="text-xs p-1 border rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none">
                                        <option value="totalTasks">Rank by Total Tasks</option>
                                        <option value="totalPoints">Rank by Total Points</option>
                                        <option value="fixQuality">Rank by Fix Quality %</option>
                                    </select>
                                </div>
                                <div class="table-container border border-gray-700 rounded-lg text-sm" style="max-height: 200px;">
                                    <table class="min-w-full divide-y divide-gray-700">
                                        <thead class="bg-gray-900/50">
                                            <tr>
                                                <th class="px-4 py-2 text-left font-medium text-gray-300">Rank</th>
                                                <th class="px-4 py-2 text-left font-medium text-gray-300">Technician</th>
                                                <th id="leaderboard-metric-header" class="px-4 py-2 text-left font-medium text-gray-300">Total Tasks</th>
                                            </tr>
                                        </thead>
                                        <tbody id="leaderboard-body" class="divide-y divide-gray-700">
                                            <tr><td class="px-4 py-2 text-gray-400" colspan="3"><i>Calculate a project to see data...</i></td></tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                             <div>
                                <h3 class="font-semibold text-gray-200">Workload Distribution</h3>
                                 <p class="text-xs text-gray-400 mb-2">Visualize task assignments across the team.</p>
                                 <div id="workload-chart-container" class="space-y-2 pr-2 overflow-y-auto border border-gray-700 rounded-lg p-2" style="max-height: 200px;">
                                    <p class="text-gray-500 italic text-sm text-center">Calculate a project to see chart...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="project-data-entry" class="lg:col-span-3 space-y-6">
                    <div class="card p-6 rounded-xl">
                        <div class="flex justify-between items-center border-b border-gray-700 pb-3 mb-4">
                            <h2 class="text-xl font-semibold text-gray-100">Project Data Entry</h2>
                            <button id="edit-data-btn" title="Edit Project Data" class="p-2 bg-gray-600 text-gray-200 rounded-lg hover:bg-gray-500 hidden">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168l10-10zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207 11.207 2.5zm1.586 3L10.5 3.207 4 9.707V10h.5a.5.5 0 0 1 .5.5v.5h.5a.5.5 0 0 1 .5.5v.5h.293l6.5-6.5zm-9.761 5.175-.106.106-1.528 3.821 3.821-1.528.106-.106A.5.5 0 0 1 5 12.5V12h-.5a.5.5 0 0 1-.5-.5V11h-.5a.5.5 0 0 1-.468-.325z"/></svg>
                            </button>
                        </div>

                        <div class="bg-yellow-900/30 border border-yellow-700/50 p-3 rounded-lg mb-4">
                             <div class="flex items-center mb-2">
                                <input id="is-ir-project-checkbox" type="checkbox" class="h-4 w-4 text-indigo-500 focus:ring-indigo-600 bg-gray-700 border-gray-600 rounded">
                                <label for="is-ir-project-checkbox" class="ml-3 block text-sm font-medium text-yellow-300">
                                    Mark Project as IR (for Fix Tasks)
                                    <span class="block text-xs text-yellow-400">Applies 1.5x points multiplier to the sum of all categories in a Fix Task row.</span>
                                </label>
                            </div>
                            <div class="flex items-center">
                                <label for="gsd-value-select" class="block text-sm font-medium text-gray-300 mr-2">GSD Point Value:</label>
                                <select id="gsd-value-select" class="w-1/2 px-3 py-1 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm">
                                    <option value="3in">3in Value</option>
                                    <option value="4in">4in Value</option>
                                    <option value="6in">6in Value</option>
                                    <option value="9in">9in Value</option>
                                </select>
                            </div>
                        </div>

                        <div id="drop-zone">
                            <label for="techData" class="block text-sm font-medium text-gray-400 mb-2">Paste raw data, or drag & drop shp and dbf file (.shp, .dbf)</label>
                            <textarea id="techData" rows="10" class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none font-mono text-sm mb-4" placeholder="Paste data or drop files..."></textarea>
                        </div>

                        <div class="flex gap-4 mt-4">
                            <input type="text" id="project-name" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Enter Project Name to Save/Update">
                            <button id="save-project-btn" class="bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-700 transition-colors duration-300 shadow-md whitespace-nowrap">Save Project</button>
                        </div>
                        <div class="mt-4">
                            <button id="calculatePastedDataBtn" class="w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-700 transition-colors duration-300 shadow-md">
                                Calculate
                            </button>
                        </div>
                    </div>
                    
                    <div id="project-progress-card" class="card p-6 rounded-xl">
                        <h2 class="text-xl font-semibold text-gray-100 border-b border-gray-700 pb-3 mb-4">Overall Project Progress</h2>
                        <div id="project-progress-content">
                             <p class="text-xs text-gray-500 italic">Project progress will be shown here after calculation.</p>
                        </div>
                    </div>

                    <div id="fix4-breakdown-card" class="card p-6 rounded-xl">
                        <h2 class="text-xl font-semibold text-gray-100 border-b border-gray-700 pb-3 mb-4">Fix4 Breakdown</h2>
                        <div id="fix4-breakdown-content" class="space-y-4 text-sm">
                            <p class="text-xs text-gray-500 italic">Breakdown will be shown here after calculation.</p>
                        </div>
                    </div>

                    <div id="tl-summary-card" class="card p-6 rounded-xl">
                        <h2 class="text-xl font-semibold text-gray-100 border-b border-gray-700 pb-3 mb-4">TL Summary</h2>
                        <div id="tl-summary-content" class="space-y-4">
                            <p class="text-xs text-gray-500 italic">Summary will be shown here after calculation.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tech-results-container" class="px-6 md:px-8 pb-8">
                 <h2 id="results-title" class="text-xl font-semibold text-gray-100 border-b border-gray-700 pb-3 mb-4">Technician Bonus Results</h2>
                 <div class="mb-4">
                    <label for="search-tech-id" class="block text-sm font-medium text-gray-400">Search by Tech ID</label>
                    <input type="text" id="search-tech-id" class="w-full md:w-1/3 mt-1 px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Search by Tech ID...">

                    <div id="team-filter-container" class="mt-3 flex flex-wrap gap-x-6 gap-y-2 items-center border-t border-gray-700 pt-3">
                         <span class="text-sm font-medium text-gray-300">Filter by Team:</span>
                         <button id="refresh-teams-btn" title="Refresh Team List" class="p-1 bg-gray-600 text-gray-300 rounded-md hover:bg-gray-500">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" class="bi bi-arrow-clockwise" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/><path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/></svg>
                        </button>
                    </div>
                 </div>
                 <div id="results-summary" class="text-sm text-gray-400 bg-blue-900/30 p-3 rounded-md mb-4 border border-blue-700/50"></div>
                 <div class="table-container border border-gray-700 rounded-lg card">
                    <table class="min-w-full divide-y divide-gray-700">
                        <thead id="results-thead" class="bg-gray-900/50 sticky top-0">
                            </thead>
                        <tbody id="tech-results-body" class="divide-y divide-gray-700">
                            </tbody>
                    </table>
                 </div>
            </div>
        </div>
    </div>

    <div id="data-view-modal" class="modal-overlay hidden">
        <div class="data-view-content">
            <div id="data-view-header" class="flex justify-between items-center mb-4">
                <h3 id="data-view-title" class="text-2xl font-bold text-white"></h3>
                <button id="data-view-close-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700">&times; Close</button>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div id="data-view-breakdown" class="lg:col-span-1 space-y-4">
                    </div>
                <div class="lg:col-span-2">
                    <div class="flex justify-between items-center mb-2">
                         <h4 class="text-lg font-semibold text-gray-200">Original Data Rows</h4>
                         <input type="text" id="data-view-search" class="px-3 py-1 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Search data...">
                    </div>
                    <div id="data-view-table-container" class="data-view-table-container">
                        </div>
                </div>
            </div>
        </div>
    </div>


    <div id="merge-fixpoints-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-gray-100 mb-2">Merge Fixpoints</h3>
            <p class="text-sm text-gray-400 mb-4">Drag and drop all team shapefiles (.shp and .dbf files) into the area below. The tool will merge their data into a single table.</p>
            <div id="merge-drop-zone" class="drop-zone-modal">
                <p>Drop .shp and .dbf files here</p>
            </div>
            <div id="merge-file-list" class="mt-4 text-xs space-y-1"></div>
            <div class="mt-6 flex justify-end gap-4">
                <button id="merge-cancel-btn" class="bg-gray-600 text-gray-200 font-bold py-2 px-4 rounded-lg hover:bg-gray-500 transition-colors">Cancel</button>
                <button id="merge-load-btn" class="bg-teal-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-700 transition-colors" disabled>Load Merged Data into Text Area</button>
            </div>
        </div>
    </div>

    <div id="team-management-modal" class="modal-overlay hidden">
        <div class="modal-content overflow-y-auto max-h-[90vh]">
            <h3 class="text-xl font-bold text-gray-100 mb-2">Team Management</h3>
            <p class="text-sm text-gray-400 mb-4">Define teams and assign Tech IDs. Paste a comma-separated list of IDs for each team. The settings are saved locally.</p>
            <div id="team-list-container" class="space-y-4"></div>
            <div class="mt-4 flex gap-4">
                <input type="text" id="new-team-name" placeholder="New Team Name" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
                <button id="add-team-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 whitespace-nowrap">Add Team</button>
            </div>
            <div class="mt-6 flex justify-end gap-4 border-t border-gray-700 pt-4">
                <button id="close-teams-modal-btn" class="bg-gray-600 text-gray-200 font-bold py-2 px-4 rounded-lg hover:bg-gray-500 transition-colors">Close</button>
                <button id="save-teams-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700">Save Team Settings</button>
            </div>
        </div>
    </div>

    <div id="reorder-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h3 class="text-xl font-bold text-gray-100 mb-2">Reorder Projects</h3>
            <p class="text-sm text-gray-400 mb-4">Drag and drop the projects to change their display order. Newest projects appear at the top by default.</p>
            <div id="reorder-list" class="space-y-2 h-64 overflow-y-auto p-2 border border-gray-600 rounded-md">
                </div>
            <div class="mt-6 flex justify-end gap-4">
                <button id="reorder-cancel-btn" class="bg-gray-600 text-gray-200 font-bold py-2 px-4 rounded-lg hover:bg-gray-500 transition-colors">Cancel</button>
                <button id="reorder-save-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Save Order</button>
            </div>
        </div>
    </div>

    <div id="info-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="flex justify-between items-start">
                 <h3 id="modal-title" class="text-xl font-bold text-gray-100 mb-4"></h3>
                 <button id="view-data-btn" class="bg-blue-600 text-white font-bold py-1 px-3 rounded-lg hover:bg-blue-700 text-sm ml-4 whitespace-nowrap">View Data</button>
            </div>
            <div id="modal-body" class="text-gray-300 space-y-2"></div>
            <button id="modal-close" class="mt-6 w-full bg-gray-600 text-gray-200 font-bold py-2 px-4 rounded-lg hover:bg-gray-500 transition-colors">Close</button>
        </div>
    </div>

    <script src="script.js"></script>
</body>
</html>
