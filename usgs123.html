<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project - Earthquake Status Map</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --card-bg-color: rgba(255, 255, 255, 0.85);
            --text-color: #2c3e50;
            --secondary-text-color: #5a6d7f;
            --accent-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --border-color: rgba(255, 255, 255, 0.6);
            --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
            --border-radius-lg: 16px;
        }

        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
        }
        
        .main-card {
            background-color: var(--card-bg-color);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            padding: 20px;
            max-width: 90vw; /* Wider for map */
            width: 100%;
            height: 90vh; /* Taller for map */
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }
        
        #loading-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--secondary-text-color);
        }
        .loader {
            border: 5px solid #e0eafc;
            border-top: 5px solid var(--accent-color);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1.2s linear infinite;
            margin-bottom: 25px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #content-container {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }

        .map-header {
            text-align: center;
            margin-bottom: 15px;
        }

        .map-header h2 {
            font-size: 1.8em;
            font-weight: 700;
            margin: 0;
            color: #485563;
        }
        .map-header p {
            font-size: 0.9em;
            color: var(--secondary-text-color);
            margin: 5px 0 0 0;
        }
        
        #earthquakeMap {
            flex-grow: 1;
            width: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .legend-card {
            background-color: white;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-top: 15px;
            font-size: 0.9em;
            text-align: left;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .legend-circle {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            border: 1px solid rgba(0,0,0,0.5);
        }
        .magnitude-text {
            font-weight: 500;
        }

        .footer-info {
            font-size: 0.8em;
            color: var(--secondary-text-color);
            width: 100%;
            padding-top: 10px;
            margin-top: 10px;
            text-align: center;
            border-top: 1px solid #e0e0e0;
        }

        #error-message { color: var(--danger-color); font-size: 1.1em; text-align: center; }
        
        /* Pop-up Styles for Alert Level */
        .alert-green { color: #27ae60; font-weight: bold; }
        .alert-yellow { color: #f39c12; font-weight: bold; }
        .alert-orange { color: #e67e22; font-weight: bold; }
        .alert-red { color: #c0392b; font-weight: bold; }
    </style>
    <link rel="icon" type="image/png" href="icon.png">
</head>
<body>

    <main class="main-card">
        <div id="loading-container">
            <div class="loader"></div>
            <h1>Loading Earthquake Map</h1>
            <p>Fetching real-time data from USGS...</p>
        </div>

        <div id="content-container" style="display: none;">
            <div class="map-header">
                <h2>Real-Time Earthquake Monitor üåç</h2>
                <p>M2.5+ Earthquakes in the Last 24 Hours (Source: USGS)</p>
            </div>

            <div id="earthquakeMap"></div>

            <div class="legend-card">
                <p style="font-weight: 600; margin-top: 0;">Magnitude Scale:</p>
                <div class="legend-item"><div class="legend-circle" style="background-color: #8aff8a; border-color: #27ae60;"></div><span class="magnitude-text">M 2.5 - 3.9 (Minor)</span></div>
                <div class="legend-item"><div class="legend-circle" style="background-color: #ffff8a; border-color: #f39c12;"></div><span class="magnitude-text">M 4.0 - 4.9 (Light)</span></div>
                <div class="legend-item"><div class="legend-circle" style="background-color: #ffaa8a; border-color: #e67e22;"></div><span class="magnitude-text">M 5.0 - 5.9 (Moderate)</span></div>
                <div class="legend-item"><div class="legend-circle" style="background-color: #ff8a8a; border-color: #c0392b;"></div><span class="magnitude-text">M 6.0+ (Strong)</span></div>
            </div>
            
            <div class="footer-info">
                Data last updated: <span id="current-time"></span>
            </div>
        </div>
        
        <div id="error-message" style="display: none;"></div>
    </main>
    
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBxlhWwf3mlS_6Q3BiUsfpH21AsbhVmDw8&callback=initMap" async defer></script>
    
    <script>
        const API_KEY = "AIzaSyBxlhWwf3mlS_6Q3BiUsfpH21AsbhVmDw8"; // Reusing key from script.js
        const USGS_FEED = 'https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/2.5_day.geojson';
        let map;

        function initMap() {
            // Updated map options for Philippines center and zoom
            const mapOptions = {
                zoom: 5, // Increased zoom level for a country view
                center: { lat: 12.88, lng: 121.77 }, // Coordinates for Philippines
                mapTypeId: 'terrain'
            };
            
            const mapElement = document.getElementById('earthquakeMap');
            map = new google.maps.Map(mapElement, mapOptions);

            // Fetch and display GeoJSON data
            map.data.loadGeoJson(USGS_FEED, null, (features) => {
                if (features && features.length > 0) {
                    map.data.setStyle((feature) => {
                        const magnitude = feature.getProperty('mag');
                        return {
                            icon: getCircle(magnitude)
                        };
                    });
                    
                    // --- FIX: Add the click listener *after* the data is loaded ---
                    addFeatureClickListener(map);

                    // Set status and time
                    document.getElementById('current-time').textContent = new Date().toLocaleTimeString();
                    document.getElementById('loading-container').style.display = 'none';
                    document.getElementById('content-container').style.display = 'flex';
                } else {
                    showError("No M2.5+ earthquakes reported in the last 24 hours.");
                }
            });
        }

        // Separate function for the click listener logic
        function addFeatureClickListener(map) {
            const infoWindow = new google.maps.InfoWindow();
            
            // This listener must be attached to the map.data object to handle GeoJSON features
            map.data.addListener('click', (event) => {
                const mag = event.feature.getProperty('mag');
                const place = event.feature.getProperty('place');
                const time = new Date(event.feature.getProperty('time')).toLocaleString();
                const url = event.feature.getProperty('url');
                
                // --- ADDED DETAILS ---
                const eventStatus = event.feature.getProperty('status') || 'N/A';
                const tsunami = event.feature.getProperty('tsunami') === 1 ? 'Yes' : 'No';
                const alertLevel = event.feature.getProperty('alert') || 'N/A';
                
                // Get Depth (Z-coordinate is the third element in the GeoJSON coordinates)
                // We use the LatLng object and then access the raw coordinates for the third dimension (depth).
                const geometry = event.feature.getGeometry();
                const coordinates = geometry.getArray ? geometry.getArray() : [];
                const depth = coordinates.length > 2 ? coordinates[2].toFixed(1) : 'N/A';
                
                // Function to style the Alert Level text
                const getAlertClass = (level) => `alert-${level.toLowerCase()}`;
                
                infoWindow.setContent(
                    `<div style="max-width: 250px; font-size: 0.9em;">` +
                    `<h3>${place}</h3>` +
                    `<p style="margin: 0; padding: 2px 0;"><strong>Magnitude:</strong> ${mag.toFixed(1)}</p>` +
                    `<p style="margin: 0; padding: 2px 0;"><strong>Depth:</strong> ${depth} km</p>` +
                    `<p style="margin: 0; padding: 2px 0;"><strong>Alert Level:</strong> <span class="${getAlertClass(alertLevel)}">${alertLevel.toUpperCase()}</span></p>` +
                    `<p style="margin: 0; padding: 2px 0;"><strong>Tsunami Risk:</strong> ${tsunami}</p>` +
                    `<p style="margin: 0; padding: 2px 0;"><strong>Event Status:</strong> ${eventStatus.toUpperCase()}</p>` +
                    `<p style="margin: 5px 0 0 0;">Time: ${time}</p>` +
                    `<a href="${url}" target="_blank">View Full USGS Report</a>` +
                    `</div>`
                );
                infoWindow.setPosition(geometry.get());
                infoWindow.open(map);
            });
        }

        function getCircle(magnitude) {
            const mag = parseFloat(magnitude);
            let color;

            if (mag >= 6.0) { color = '#c0392b'; }      // Strong (Dark Red)
            else if (mag >= 5.0) { color = '#e67e22'; } // Moderate (Orange)
            else if (mag >= 4.0) { color = '#f39c12'; } // Light (Yellow)
            else { color = '#27ae60'; }                 // Minor (Green)

            return {
                path: google.maps.SymbolPath.CIRCLE,
                fillColor: color,
                fillOpacity: 0.7,
                scale: Math.pow(2, mag) / 2, // Scale circle size by magnitude
                strokeColor: 'white',
                strokeWeight: 0.5
            };
        }

        function showError(message) {
            document.getElementById('loading-container').style.display = 'none';
            const errorElement = document.getElementById('error-message');
            errorElement.textContent = `Error: ${message}`;
            errorElement.style.display = 'block';
            document.querySelector('.main-card').style.height = 'auto'; 
        }

        // Handle case where Google Maps API fails to load
        window.onerror = (message) => {
            if (message.includes('google.maps')) {
                showError("Failed to load Google Maps. Check your API key and browser console for details.");
            }
        };

        // Fallback for initMap if the API doesn't call it (e.g., if the key is invalid or blocked)
        setTimeout(() => {
            if (!map) {
                // Check if the script tag has loaded successfully (only possible if not blocked)
                const scriptLoaded = document.querySelector(`script[src*="${API_KEY}"]`);
                if (scriptLoaded) {
                    // Try calling initMap again if the API failed to do so automatically
                    if (typeof initMap === 'function') {
                        initMap();
                    }
                } else {
                    // If script didn't even load, it's likely an API key or connection issue
                    showError("Map script failed to load. Check your network connection or API key restrictions.");
                }
            }
        }, 5000);
    </script>
</body>
</html>
